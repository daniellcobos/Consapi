<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultor Integral - Tork Solutions</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 1400px;
            padding: 0;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 80vh;
        }

        h1 {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .intro {
            color: #64748b;
            font-size: 1.2em;
            margin-bottom: 35px;
            font-weight: 500;
        }

        .progress-container {
            margin-bottom: 35px;
        }

        .step-indicators {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
            background: #e2e8f0;
            color: #94a3b8;
            border: 3px solid #e2e8f0;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border-color: #1e40af;
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
            transform: scale(1.1);
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border-color: #059669;
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }

        .step-circle.completed::before {
            content: '‚úì';
            font-size: 1.2em;
            font-weight: 900;
        }

        .step-label {
            margin-top: 10px;
            font-size: 0.9em;
            font-weight: 600;
            color: #64748b;
            text-align: center;
            transition: color 0.3s ease;
        }

        .step-indicator.active .step-label {
            color: #1e40af;
        }

        .step-indicator.completed .step-label {
            color: #059669;
        }

        .step-connector {
            position: absolute;
            top: 25px;
            left: 50px;
            right: 50px;
            height: 3px;
            background: #e2e8f0;
            z-index: 1;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, #059669, #10b981);
        }

        .progress-bar {
            background: rgba(226, 232, 240, 0.8);
            border-radius: 15px;
            height: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            background: linear-gradient(90deg, #1e40af, #3b82f6, #60a5fa);
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .question-box {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-left: 6px solid #1e40af;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: left;
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.1);
            position: relative;
            overflow: hidden;
        }

        .question-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #1e40af, #3b82f6, #60a5fa);
        }

        .question-box h2 {
            font-size: 1.6em;
            color: #1e40af;
            margin: 0 0 15px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .question-box h2::before {
            content: 'üìã';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .question-box p {
            font-size: 1.1em;
            color: #475569;
            margin: 0;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .quiz-content .form-group:first-child {
            margin-top: 0;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1e40af;
            font-size: 1.1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-button {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 20px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
            position: relative;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .option-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .option-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(30, 64, 175, 0.4);
        }

        .option-button:hover::before {
            left: 100%;
        }

        .option-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }

        .nav-button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .btn-prev {
            background: linear-gradient(135deg, #64748b, #94a3b8);
            color: white;
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
        }

        .btn-prev:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(100, 116, 139, 0.4);
        }

        .btn-next {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(30, 64, 175, 0.4);
        }

        .btn-next:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .recommendation {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-left: 6px solid #1e40af;
            padding: 30px;
            border-radius: 15px;
            text-align: left;
            box-shadow: 0 15px 35px rgba(30, 64, 175, 0.1);
            position: relative;
        }

        .recommendation h2 {
            font-size: 2em;
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .recommendation h2::before {
            content: 'üéØ';
            margin-right: 15px;
            font-size: 1.2em;
        }

        .recommendation-group {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(30, 64, 175, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .recommendation-group h3 {
            font-size: 1.3em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #1e40af;
            font-weight: 600;
        }

        .recommendation-group ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .recommendation-group li {
            background: linear-gradient(135deg, #bfdbfe, #dbeafe);
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 500;
            color: #1e40af;
            font-size: 0.9em;
        }

        .company-summary {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.1);
        }

        .company-summary h3 {
            color: #0369a1;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }

        .company-summary h3::before {
            content: 'üè¢';
            margin-right: 10px;
        }

        .company-summary p {
            margin: 8px 0;
            color: #475569;
            font-weight: 500;
        }

        .consumption-results {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 2px solid #10b981;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.1);
        }

        .consumption-results h3 {
            color: #047857;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.4em;
        }

        .consumption-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #10b981;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .consumption-item h4 {
            color: #047857;
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .consumption-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #059669;
            background: linear-gradient(135deg, #059669, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reference-selector {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reference-selector label {
            font-weight: 600;
            color: #047857;
            min-width: 120px;
        }

        .reference-selector select {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
            color: #047857;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .reference-selector select:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .recalculate-btn {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .recalculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .calculating {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #64748b;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .step-description {
            margin-bottom: 25px;
        }

        .description-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.1);
            position: relative;
        }

        .description-box::before {
            content: 'üí°';
            position: absolute;
            top: -10px;
            left: 20px;
            background: white;
            padding: 5px 10px;
            border-radius: 50%;
            font-size: 1.2em;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
        }

        .description-box h4 {
            color: #0369a1;
            margin: 0 0 10px 0;
            font-weight: 600;
            font-size: 1.2em;
            padding-left: 5px;
        }

        .description-box p {
            color: #475569;
            margin: 0;
            line-height: 1.6;
            font-size: 1em;
            padding-left: 5px;
        }

        .left-sidebar {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 20px 0 0 20px;
            padding: 30px 25px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 20px;
        }

        .sidebar-header h1 {
            color: white;
            background: none;
            -webkit-text-fill-color: white;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .sidebar-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95em;
            margin: 0;
        }

        .steps-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            cursor: pointer;
        }

        .step-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .step-item.completed {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .step-item.completed::before {
            content: '‚úì';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #10b981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9em;
        }

        .step-item.active .step-number {
            background: rgba(255, 255, 255, 0.4);
        }

        .step-content-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .step-description-text {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .right-content {
            padding: 40px;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 0 20px 20px 0;
        }

        .content-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .content-header h2 {
            color: #1e40af;
            font-size: 2em;
            margin: 0 0 15px 0;
            font-weight: 700;
        }

        .content-header .progress-info {
            color: #64748b;
            font-size: 1.1em;
            font-weight: 500;
        }

        .quiz-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hidden {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 300px 1fr;
                max-width: 1200px;
            }
            
            .left-sidebar {
                padding: 25px 20px;
            }
            
            .right-content {
                padding: 30px;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 600px;
                margin: 10px;
            }
            
            .left-sidebar {
                border-radius: 20px 20px 0 0;
                padding: 20px;
            }
            
            .right-content {
                border-radius: 0 0 20px 20px;
                padding: 25px;
            }
            
            .steps-list {
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
                padding-bottom: 10px;
            }
            
            .step-item {
                min-width: 200px;
                padding: 15px;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
        }

        /* Responsive design for recommendation grid */
        @media (max-width: 1024px) {
            .recommendation-group div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
        }

        /* Selectize custom styles */
        .selectize-control {
            width: 100% !important;
        }
        
        .selectize-control .selectize-input {
            width: 100% !important;
            min-width: 300px !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        .selectize-control .selectize-input input {
            width: 100% !important;
            min-width: 250px !important;
        }
        
        .selectize-control.single .selectize-input {
            height: auto !important;
            padding: 8px 12px !important;
        }
    </style>
    <!-- Incluye las bibliotecas jsPDF y html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jQuery (required for Selectize) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.default.min.css"
  integrity="sha512-pTaEn+6gF1IeWv3W1+7X7eM60TFu/agjgoHmYhAfLEU8Phuf6JKiiE8YmsNC0aCgQv4192s4Vai8YZ6VNM6vyQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js"
  integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>i
</head>
<body>
    <div class="container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <h1>Consultor Integral Tork</h1>
                <p>Encuentra las mejores soluciones de higiene para tu empresa</p>
            </div>
            <div class="steps-list" id="steps-list">
                <!-- Los pasos se generar√°n din√°micamente -->
            </div>
        </div>
        
        <!-- Right Content -->
        <div class="right-content">
            <div class="content-header">
                <h2 id="current-step-title">Informaci√≥n de la Empresa</h2>
                <p class="progress-info" id="progress-info">Paso 1 de 4</p>
            </div>
            
            <div class="quiz-content">
                <div id="quiz-container">
                    <!-- El contenido se generar√° din√°micamente aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos de la empresa del usuario
        let companyData = {};
        
        // Datos de segmentaci√≥n de productos
        const productData = {
            "Papel Higi√©nico": {
                "Higiene Cr√≠tica": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork SmartOne¬Æ Mini", "referencias": ["204028", "71611"], "dispensador": ["83701"] },
                    "Tr√°fico Medio": { "posicionamiento": "Jumbos L√≠nea Legacy", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                    "Tr√°fico Alto": { "posicionamiento": "Jumbos L√≠nea Legacy", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                    "Tr√°fico Pico": { "posicionamiento": "Tork SmartOne¬Æ Maxi", "referencias": ["202581", "71187"], "dispensador": ["83600"] }
                },
                "Wow Factor": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork SmartOne¬Æ Mini", "referencias": ["204028", "71611"], "dispensador": ["83701"] },
                    "Tr√°fico Medio": { "posicionamiento": "Jumbos L√≠nea Legacy", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                    "Tr√°fico Alto": [
                        { "posicionamiento": "Jumbos L√≠nea Legacy", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                        { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202581", "71187"], "dispensador": ["83600"] }
                    ],
                    "Tr√°fico Pico": { "posicionamiento": "Tork SmartOne¬Æ Maxi", "referencias": ["202581", "71187"], "dispensador": ["83600"] }
                },
                "Restroom Plus": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork SmartOne¬Æ Mini", "referencias": ["204028", "71611"], "dispensador": ["83701"] },
                    "Tr√°fico Medio": [
                        { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                        { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202580", "71457", "71107", "71117", "71357", "71557"], "dispensador": ["201588"] }
                    ],
                    "Tr√°fico Alto": [
                        { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["71610", "71613"], "dispensador": ["837010"] },
                        { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202580", "71457", "71107", "71117", "71357", "71557"], "dispensador": ["201588"] }
                    ],
                    "Tr√°fico Pico": { "posicionamiento": "Tork SmartOne¬Æ Maxi", "referencias": ["202581", "71187"], "dispensador": ["83600"] }
                },
                "Essential": {
                    "Tr√°fico Bajo": { "posicionamiento": "Convencionales", "referencias": ["202019", "201763", "201764", "201647"], "dispensador": ["ND"] },
                    "Tr√°fico Medio": { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202580", "71457", "71107", "71117", "71357", "71557"], "dispensador": ["201588"] },
                    "Tr√°fico Alto": { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202580", "71457", "71107", "71117", "71357", "71557"], "dispensador": ["201588"] },
                    "Tr√°fico Pico": { "posicionamiento": "Jumbos L√≠nea Image", "referencias": ["202580", "71457", "71107", "71117", "71357", "71557"], "dispensador": ["201588"] }
                }
            },
            "Toallas de Manos": {
                "Higiene Cr√≠tica": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork Xpress¬Æ", "referencias": ["73528", "73554", "200246", "73538"], "dispensador": ["83096", "83051", "83050", "83610"] },
                    "Tr√°fico Medio": { "posicionamiento": "Tork Flujo Central", "referencias": ["73575", "73689", "83160", "73669", "73748"], "dispensador": ["83160"] },
                    "Tr√°fico Alto": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708"], "dispensador": ["83962", "203543"] },
                    "Tr√°fico Pico": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708"], "dispensador": ["83962", "203543"] }
                },
                "Wow Factor": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork Xpress¬Æ", "referencias": ["73528", "73554", "200246", "73538"], "dispensador": ["83096", "83051", "83050", "83610"] },
                    "Tr√°fico Medio": { "posicionamiento": "Tork Flujo Central", "referencias": ["73575", "73689", "83160", "73669", "73748"], "dispensador": ["83160"] },
                    "Tr√°fico Alto": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708"], "dispensador": ["83962", "203543"] },
                    "Tr√°fico Pico": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708",], "dispensador": ["83962", "203543"] }
                },
                "Restroom Plus": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork Xpress¬Æ", "referencias": ["73528", "73554", "200246", "73538"], "dispensador": ["83096", "83051", "83050", "83610"] },
                    "Tr√°fico Medio": { "posicionamiento": "Tork Flujo Central", "referencias": ["73575", "73689", "73669", "73748"], "dispensador": ["83160"] },
                    "Tr√°fico Alto": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708" ], "dispensador": ["83962", "203543"] },
                    "Tr√°fico Pico": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708" ], "dispensador": ["83962", "203543"] }
                },
                "Essential": {
                    "Tr√°fico Bajo": { "posicionamiento": "Tork Xpress¬Æ", "referencias": ["73528", "73554", "200246", "73538"], "dispensador": ["83096", "83051", "83050", "83610"] },
                    "Tr√°fico Medio": { "posicionamiento": "Tork Flujo Central", "referencias": ["73575", "73689", "73669", "73748"], "dispensador": ["83160"] },
                    "Tr√°fico Alto": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708"], "dispensador": ["83962", "203543"] },
                    "Tr√°fico Pico": { "posicionamiento": "Tork PeakServe¬Æ", "referencias": ["73657", "203542", "73708"], "dispensador": ["83962", "203543"] }
                }
            },
            "Jabones y Gel": {
                "Higiene Cr√≠tica": {
                    "Tr√°fico Bajo": { "posicionamiento": "NA", "referencias": ["203230", "203169"], "dispensador": ["203166"] },
                    "Tr√°fico Medio": { "posicionamiento": "NA", "referencias": ["80506", "80107", "80541"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Alto": { "posicionamiento": "NA", "referencias": ["80506", "80107", "80541"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Pico": { "posicionamiento": "NA", "referencias": ["80506", "80107", "80541"], "dispensador": ["83530", "83510"] }
                },
                "Wow Factor": {
                    "Tr√°fico Bajo": { "posicionamiento": "NA", "referencias": ["203230", "203169"], "dispensador": ["203166"] },
                    "Tr√°fico Medio": { "posicionamiento": "NA", "referencias": ["80530"], "dispensador": ["83620"] },
                    "Tr√°fico Alto": { "posicionamiento": "NA", "referencias": ["80530"], "dispensador": ["83620"] },
                    "Tr√°fico Pico": { "posicionamiento": "NA", "referencias": ["80530"], "dispensador": ["83620"] }
                },
                "Restroom Plus": {
                    "Tr√°fico Bajo": { "posicionamiento": "NA", "referencias": ["203230", "203169"], "dispensador": ["203166"] },
                    "Tr√°fico Medio": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Alto": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Pico": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] }
                },
                "Essential": {
                    "Tr√°fico Bajo": { "posicionamiento": "NA", "referencias": ["203230", "203169"], "dispensador": ["203166"] },
                    "Tr√°fico Medio": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Alto": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] },
                    "Tr√°fico Pico": { "posicionamiento": "NA", "referencias": ["80506", "80530"], "dispensador": ["83530", "83510"] }
                }
            }
        };
        
        // Estado del cuestionario
        let currentStep = 0;
        let selectedProducts = [];
        let selectedPublicTypes = [];
        let selectedBathroomSegment = '';
        
        // Definici√≥n de pasos del cuestionario
        const steps = [
            {
                id: 'company-sector',
                title: 'Informaci√≥n de la Empresa',
                shortTitle: 'Empresa',
                icon: 'üè¢',
                description: '¬øPor qu√© necesitamos esta informaci√≥n?',
                justification: 'El sector de su empresa y su tama√±o determinan las necesidades espec√≠ficas de higiene. Por ejemplo, el sector salud requiere est√°ndares de higiene cr√≠tica, mientras que empresas m√°s grandes necesitan soluciones de mayor capacidad y eficiencia.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© necesitamos esta informaci√≥n?</h4>
                            <p>El sector de su empresa y su tama√±o determinan las necesidades espec√≠ficas de higiene. Por ejemplo, el sector salud requiere est√°ndares de higiene cr√≠tica, mientras que empresas m√°s grandes necesitan soluciones de mayor capacidad y eficiencia.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companySector">Sector de la empresa:</label>
                        <select id="companySector" required>
                            <option value="">-- Selecciona un sector --</option>
                            <option value="Oficinas / Corporativo">Oficinas / Corporativo</option>
                            <option value="Industria / Manufactura">Industria / Manufactura</option>
                            <option value="Salud (Hospitales, Cl√≠nicas)">Salud (Hospitales, Cl√≠nicas)</option>
                            <option value="Educaci√≥n (Colegios, Universidades)">Educaci√≥n (Colegios, Universidades)</option>
                            <option value="HoReCa (Hoteles, Restaurantes, Cafeter√≠as)">HoReCa (Hoteles, Restaurantes, Cafeter√≠as)</option>
                            <option value="Retail / Comercio">Retail / Comercio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="companySize">Tama√±o de la empresa (n√∫mero de empleados):</label>
                        <select id="companySize" required>
                            <option value="">-- Selecciona el tama√±o --</option>                        
                            <option value="11-50">Peque√±a 11-50 empleados</option>
                            <option value="51-200">Mediana 51-200 empleados</option>
                            <option value="200+">Grande M√°s de 500 empleados</option>
                        </select>
                    </div>
                `
            },
            {
                id: 'demographics',
                title: 'Demograf√≠a y Jornada Laboral',
                shortTitle: 'Demograf√≠a',
                icon: 'üë•',
                description: '¬øPor qu√© preguntamos sobre demograf√≠a?',
                justification: 'Los patrones de uso var√≠an entre g√©neros y la intensidad de trabajo afecta la frecuencia de uso de los productos. Esta informaci√≥n nos permite calcular el consumo mensual exacto y recomendar la capacidad de dispensadores adecuada.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© preguntamos sobre demograf√≠a?</h4>
                            <p>Los patrones de uso var√≠an entre g√©neros y la intensidad de trabajo afecta la frecuencia de uso de los productos. Esta informaci√≥n nos permite calcular el consumo mensual exacto y recomendar la capacidad de dispensadores adecuada.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="numMujeres">N√∫mero de mujeres:</label>
                        <input type="number" id="numMujeres" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="numHombres">N√∫mero de hombres:</label>
                        <input type="number" id="numHombres" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="diasLaborales">D√≠as laborales por mes:</label>
                        <input type="number" id="diasLaborales" min="1" max="31" value="30" required>
                    </div>
                    <div class="form-group">
                        <label for="horasLaborales">Horas laborales por d√≠a:</label>
                        <input type="number" id="horasLaborales" min="1" max="24" value="8" required>
                    </div>
                `
            },
            {
                id: 'public-type',
                title: 'Tipo de P√∫blico',
                shortTitle: 'P√∫blico',
                icon: 'üö∂',
                description: '¬øPor qu√© es importante el tipo de p√∫blico?',
                justification: 'Diferentes tipos de usuarios tienen distintos patrones de consumo y expectativas de calidad. El personal administrativo y los visitantes esperan mayor comodidad, mientras que el personal operativo necesita productos m√°s resistentes. Esta clasificaci√≥n nos ayuda a determinar el segmento de producto m√°s apropiado.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© es importante el tipo de p√∫blico?</h4>
                            <p>Diferentes tipos de usuarios tienen distintos patrones de consumo y expectativas de calidad. El personal administrativo y los visitantes esperan mayor comodidad, mientras que el personal operativo necesita productos m√°s resistentes. Esta clasificaci√≥n nos ayuda a determinar el segmento de producto m√°s apropiado.</p>
                        </div>
                    </div>
                    <p>¬øQu√© tipos de p√∫blico visitan sus instalaciones? (Puede seleccionar m√∫ltiples opciones)</p>
                    <div class="options-container">
                        <button type="button" class="option-button public-option" data-public="administrativo">
                            <strong>üëî Administrativo</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Personal de oficina, gerentes, empleados de escritorio</span>
                        </button>
                        <button type="button" class="option-button public-option" data-public="operativo">
                            <strong>üîß Operativo</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Personal de producci√≥n, t√©cnicos, trabajadores de campo</span>
                        </button>
                        <button type="button" class="option-button public-option" data-public="flotante">
                            <strong>üö∂ Flotante</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Visitantes, clientes, personal temporal o externo</span>
                        </button>
                    </div>
                    
                    <div id="proporcion-container" class="hidden" style="margin-top: 30px;">
                        <div class="description-box">
                            <h4>Distribuci√≥n de P√∫blico</h4>
                            <p>Por favor, especifique la proporci√≥n de cada tipo de p√∫blico en su empresa (debe sumar 100%):</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div class="form-group" id="proporcion-administrativo" style="display: none;">
                                <label for="prop-administrativo" style="color: #1e40af;">üëî Administrativo (%):</label>
                                <input type="number" id="prop-administrativo" min="0" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                            
                            <div class="form-group" id="proporcion-operativo" style="display: none;">
                                <label for="prop-operativo" style="color: #1e40af;">üîß Operativo (%):</label>
                                <input type="number" id="prop-operativo" min="0" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <p id="total-porcentaje" style="font-weight: 600; color: #059669;">Total: 100%</p>
                        </div>
                    </div>
                    
                    <div id="visitantes-container" class="hidden" style="margin-top: 30px;">
                        <div class="description-box">
                            <h4>Visitantes Flotantes</h4>
                            <p>Por favor, especifique el n√∫mero estimado de visitantes diarios que utilizan las instalaciones:</p>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="num-visitantes" style="color: #1e40af;">üö∂ N√∫mero estimado de visitantes por d√≠a:</label>
                            <input type="number" id="num-visitantes" min="0" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; max-width: 300px;">
                        </div>
                    </div>
                `
            },
            {
                id: 'product-selection',
                title: 'Selecci√≥n de Productos y Segmento',
                shortTitle: 'Productos',
                icon: 'üßª',
                description: '¬øPor qu√© seleccionar productos y segmento espec√≠ficos?',
                justification: 'Cada producto tiene diferentes especificaciones t√©cnicas, frecuencias de uso y m√©todos de dispensaci√≥n. El segmento de ba√±o determina el nivel de calidad y experiencia del usuario. Esta informaci√≥n nos permite ofrecer recomendaciones precisas de referencias, dispensadores y calcular el consumo mensual espec√≠fico.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© seleccionar productos y segmento espec√≠ficos?</h4>
                            <p>Cada producto tiene diferentes especificaciones t√©cnicas, frecuencias de uso y m√©todos de dispensaci√≥n. El segmento de ba√±o determina el nivel de calidad y experiencia del usuario. Esta informaci√≥n nos permite ofrecer recomendaciones precisas de referencias, dispensadores y calcular el consumo mensual espec√≠fico.</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.3em;">Productos de Higiene</h3>
                        <p>¬øQu√© productos de higiene necesita su empresa? (Puede seleccionar m√∫ltiples opciones)</p>
                        <div class="options-container">
                            <button type="button" class="option-button product-option" data-product="Papel Higi√©nico">Papel Higi√©nico</button>
                            <button type="button" class="option-button product-option" data-product="Toallas de Manos">Toallas de Manos</button>
                            <button type="button" class="option-button product-option" data-product="Jabones y Gel">Jabones y Gel</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.3em;">Segmento de Ba√±os</h3>
                        <p>Seleccione el segmento que mejor describe las expectativas y necesidades de sus ba√±os:</p>
                        <div class="options-container">
                            <button type="button" class="option-button segment-option" data-segment="Essential">
                                <strong>üè¢ Essential</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Funcionalidad b√°sica y costo-efectivo</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Restroom Plus">
                                <strong>‚ú® Restroom Plus</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Calidad mejorada y mayor comodidad</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Wow Factor">
                                <strong>üåü Wow Factor</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Experiencia premium y m√°xima satisfacci√≥n</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Higiene Cr√≠tica">
                                <strong>üè• Higiene Cr√≠tica</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">M√°ximos est√°ndares sanitarios y seguridad</span>
                            </button>
                        </div>
                    </div>
                `
            }
        ];
        
        function initializeStepsList() {
            const container = document.getElementById('steps-list');
            container.innerHTML = '';
            
            steps.forEach((step, index) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';
                stepItem.id = `step-item-${index}`;
                
                stepItem.innerHTML = `
                    <div class="step-content-title">
                        <span class="step-number">${index + 1}</span>
                        ${step.shortTitle}
                    </div>
                    <div class="step-description-text">
                        ${step.justification.substring(0, 100)}...
                    </div>
                `;
                
                container.appendChild(stepItem);
            });
            
            updateStepsList();
        }
        
        function updateStepsList() {
            steps.forEach((step, index) => {
                const stepItem = document.getElementById(`step-item-${index}`);
                
                // Reset classes
                stepItem.className = 'step-item';
                
                if (index < currentStep) {
                    // Completed step
                    stepItem.classList.add('completed');
                } else if (index === currentStep) {
                    // Active step
                    stepItem.classList.add('active');
                } else {
                    // Future step - keep default styling
                }
            });
        }

        function updateProgress() {
            updateStepsList();
            
            // Update content header
            const step = steps[currentStep];
            document.getElementById('current-step-title').textContent = step.title;
            document.getElementById('progress-info').textContent = `Paso ${currentStep + 1} de ${steps.length}`;
        }
        
        function renderStep() {
            const step = steps[currentStep];
            const container = document.getElementById('quiz-container');
            
            container.innerHTML = `
                ${step.content}
                <div class="navigation-buttons">
                    <button class="nav-button btn-prev" onclick="previousStep()" ${currentStep === 0 ? 'style="visibility: hidden;"' : ''}>
                        Anterior
                    </button>
                    <button class="nav-button btn-next" onclick="nextStep()" id="next-btn">
                        ${currentStep === steps.length - 1 ? 'Generar Recomendaciones' : 'Siguiente'}
                    </button>
                </div>
            `;
            
            updateProgress();
            attachEventListeners();
        }
        
        function attachEventListeners() {
            // Event listeners para selecci√≥n de productos
            document.querySelectorAll('.product-option').forEach(button => {
                button.addEventListener('click', function() {
                    const product = this.dataset.product;
                    if (selectedProducts.includes(product)) {
                        selectedProducts = selectedProducts.filter(p => p !== product);
                        this.style.background = 'linear-gradient(135deg, #1e40af, #3b82f6)';
                    } else {
                        selectedProducts.push(product);
                        this.style.background = 'linear-gradient(135deg, #059669, #10b981)';
                    }
                });
            });
            
            // Event listeners para selecci√≥n de tipos de p√∫blico
            document.querySelectorAll('.public-option').forEach(button => {
                button.addEventListener('click', function() {
                    const publicType = this.dataset.public;
                    if (selectedPublicTypes.includes(publicType)) {
                        selectedPublicTypes = selectedPublicTypes.filter(p => p !== publicType);
                        this.style.background = 'linear-gradient(135deg, #1e40af, #3b82f6)';
                    } else {
                        selectedPublicTypes.push(publicType);
                        this.style.background = 'linear-gradient(135deg, #059669, #10b981)';
                    }
                    
                    // Mostrar/ocultar inputs de proporci√≥n
                    updateProporcionInputs();
                });
            });
            
            // Event listeners para los inputs de proporci√≥n
            const propAdm = document.getElementById('prop-administrativo');
            const propOp = document.getElementById('prop-operativo');
            if (propAdm && propOp) {
                [propAdm, propOp].forEach(input => {
                    input.addEventListener('input', updateTotalPorcentaje);
                });
            }
            
            // Event listeners para selecci√≥n de segmento de ba√±os
            document.querySelectorAll('.segment-option').forEach(button => {
                button.addEventListener('click', function() {
                    const segment = this.dataset.segment;
                    
                    // Reset all segment buttons to default style
                    document.querySelectorAll('.segment-option').forEach(btn => {
                        btn.style.background = 'linear-gradient(135deg, #1e40af, #3b82f6)';
                    });
                    
                    // Set the selected segment
                    selectedBathroomSegment = segment;
                    this.style.background = 'linear-gradient(135deg, #059669, #10b981)';
                });
            });
        }
        
        function updateProporcionInputs() {
            const proporcionContainer = document.getElementById('proporcion-container');
            const visitantesContainer = document.getElementById('visitantes-container');
            const propAdmContainer = document.getElementById('proporcion-administrativo');
            const propOpContainer = document.getElementById('proporcion-operativo');
            
            // Check which public types are selected
            const hasAdministrativo = selectedPublicTypes.includes('administrativo');
            const hasOperativo = selectedPublicTypes.includes('operativo');
            const hasFlotante = selectedPublicTypes.includes('flotante');
            
            // Show proportion inputs when both administrativo and operativo are selected
            if (hasAdministrativo && hasOperativo) {
                proporcionContainer.classList.remove('hidden');
                propAdmContainer.style.display = 'block';
                propOpContainer.style.display = 'block';
                updateTotalPorcentaje();
            } else {
                proporcionContainer.classList.add('hidden');
                propAdmContainer.style.display = 'none';
                propOpContainer.style.display = 'none';
            }
            
            // Show visitor input when flotante is selected
            if (hasFlotante) {
                visitantesContainer.classList.remove('hidden');
            } else {
                visitantesContainer.classList.add('hidden');
            }
        }
        
        function updateTotalPorcentaje() {
            const propAdm = parseInt(document.getElementById('prop-administrativo').value) || 0;
            const propOp = parseInt(document.getElementById('prop-operativo').value) || 0;
            const total = propAdm + propOp;
            
            const totalElement = document.getElementById('total-porcentaje');
            totalElement.textContent = `Total: ${total}%`;
            
            if (total === 100) {
                totalElement.style.color = '#059669';
            } else if (total > 100) {
                totalElement.style.color = '#dc2626';
            } else {
                totalElement.style.color = '#f59e0b';
            }
        }
        
        function validateStep() {
            const stepId = steps[currentStep].id;
            
            switch(stepId) {
                case 'company-sector':
                    const sector = document.getElementById('companySector').value;
                    const size = document.getElementById('companySize').value;
                    if (!sector || !size) return false;
                    companyData.sector = sector;
                    companyData.size = size;
                    break;
                    
                case 'demographics':
                    const mujeres = document.getElementById('numMujeres').value;
                    const hombres = document.getElementById('numHombres').value;
                    const dias = document.getElementById('diasLaborales').value;
                    const horas = document.getElementById('horasLaborales').value;
                    if (!mujeres || !hombres || !dias || !horas) return false;
                    companyData.numMujeres = parseInt(mujeres);
                    companyData.numHombres = parseInt(hombres);
                    companyData.diasLaborales = parseInt(dias);
                    companyData.horasLaborales = parseInt(horas);
                    break;
                    
                case 'public-type':
                    if (selectedPublicTypes.length === 0) return false;
                    
                    // Check which public types are selected
                    const hasAdministrativo = selectedPublicTypes.includes('administrativo');
                    const hasOperativo = selectedPublicTypes.includes('operativo');
                    const hasFlotante = selectedPublicTypes.includes('flotante');
                    
                    // Validate proportions when both administrativo and operativo are selected
                    if (hasAdministrativo && hasOperativo) {
                        const propAdm = parseInt(document.getElementById('prop-administrativo').value) || 0;
                        const propOp = parseInt(document.getElementById('prop-operativo').value) || 0;
                        
                        if (propAdm + propOp !== 100) {
                            alert('Las proporciones deben sumar exactamente 100%');
                            return false;
                        }
                        
                        // Save proportions in companyData
                        companyData.proporciones = {
                            administrativo: propAdm,
                            operativo: propOp
                        };
                    }
                    
                    // Validate visitor count when flotante is selected
                    if (hasFlotante) {
                        const numVisitantes = parseInt(document.getElementById('num-visitantes').value);
                        if (!numVisitantes || numVisitantes <= 0) {
                            alert('Debe ingresar un n√∫mero v√°lido de visitantes diarios');
                            return false;
                        }
                        
                        // Save visitor count in companyData
                        companyData.numVisitantes = numVisitantes;
                    }
                    
                    companyData.tipoPublico = selectedPublicTypes;
                    break;
                    
                case 'product-selection':
                    if (selectedProducts.length === 0) return false;
                    if (!selectedBathroomSegment) return false;
                    companyData.products = selectedProducts;
                    companyData.bathroomSegment = selectedBathroomSegment;
                    break;
            }
            
            return true;
        }
        
        function nextStep() {
            if (!validateStep()) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }
            
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep();
            } else {
                generateRecommendations();
            }
        }
        
        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }
        
        function determineTrafficLevel(numEmployees, diasLaborales, horasLaborales) {
            // Calcular intensidad de uso basada en empleados, d√≠as y horas laborales
            
            // Factor de intensidad horaria (horas/d√≠a)
            let intensityFactor = 1;
            if (horasLaborales >= 16) {
                intensityFactor = 1.5; // Turnos de 24 horas o m√∫ltiples turnos
            } else if (horasLaborales >= 12) {
                intensityFactor = 1.3; // Jornadas extendidas
            } else if (horasLaborales >= 8) {
                intensityFactor = 1.0; // Jornada normal
            } else {
                intensityFactor = 0.8; // Jornadas reducidas
            }
            
            // Factor de frecuencia mensual (d√≠as/mes)
            let frequencyFactor = 1;
            if (diasLaborales >= 28) {
                frequencyFactor = 1.4; // Operaci√≥n casi continua
            } else if (diasLaborales >= 22) {
                frequencyFactor = 1.2; // Operaci√≥n intensa (m√°s de 5 d√≠as/semana)
            } else if (diasLaborales >= 20) {
                frequencyFactor = 1.0; // Operaci√≥n est√°ndar (5 d√≠as/semana)
            } else if (diasLaborales >= 15) {
                frequencyFactor = 0.8; // Operaci√≥n reducida
            } else {
                frequencyFactor = 0.6; // Operaci√≥n muy reducida
            }
            
            // √çndice de tr√°fico ajustado
            const adjustedTrafficIndex = numEmployees * intensityFactor * frequencyFactor;
            
            // Clasificaci√≥n basada en el √≠ndice ajustado
            if (adjustedTrafficIndex < 40) return "Tr√°fico Bajo";
            if (adjustedTrafficIndex < 180) return "Tr√°fico Medio";
            if (adjustedTrafficIndex < 450) return "Tr√°fico Alto";
            return "Tr√°fico Pico";
        }
        
        function determineSegment(sector, size, tiposPublico) {
            // L√≥gica para determinar el segmento basado en sector, tama√±o y tipos de p√∫blico
            if (sector === 'Salud (Hospitales, Cl√≠nicas)') return 'Higiene Cr√≠tica';
            if (sector === 'HoReCa (Hoteles, Restaurantes, Cafeter√≠as)') return 'Higiene Cr√≠tica';
            
            // Considerar si hay tipo de p√∫blico flotante para segmentaci√≥n premium
            const hasFlotante = Array.isArray(tiposPublico) ? tiposPublico.includes('flotante') : tiposPublico === 'flotante';
            const hasMultipleTypes = Array.isArray(tiposPublico) && tiposPublico.length > 1;
            
            // Segmentaci√≥n premium para p√∫blico flotante o m√∫ltiples tipos
            if ((hasFlotante || hasMultipleTypes) && size === '200+') return 'Wow Factor';
            if ((hasFlotante || hasMultipleTypes) && (size === '51-200' || size === '11-50')) return 'Restroom Plus';
            
            if (size === '200+') return 'Wow Factor';
            if (size === '51-200') return 'Restroom Plus';
            return 'Essential';
        }
        
        function generateRecommendations() {
            const totalEmployees = companyData.numMujeres + companyData.numHombres;
            const trafficLevel = determineTrafficLevel(totalEmployees, companyData.diasLaborales, companyData.horasLaborales);
            const segment = companyData.bathroomSegment; // Use user-selected segment
            
            let recommendationsHTML = `
                <div class="recommendation" id="report-content">
                    <h2>Recomendaciones Personalizadas</h2>
                    
                    <div class="company-summary">
                        <h3>Resumen de su Empresa</h3>
                        <p><strong>Sector:</strong> ${companyData.sector}</p>
                        <p><strong>Tama√±o:</strong> ${companyData.size}</p>
                        <p><strong>Total empleados:</strong> ${totalEmployees} (${companyData.numMujeres} mujeres, ${companyData.numHombres} hombres)</p>
                        <p><strong>Jornada laboral:</strong> ${companyData.diasLaborales} d√≠as/mes, ${companyData.horasLaborales} horas/d√≠a</p>
                        <p><strong>Tipo de p√∫blico:</strong> ${companyData.tipoPublico}</p>
                        <p><strong>Segmento seleccionado:</strong> ${segment}</p>
                        <p><strong>Nivel de tr√°fico:</strong> ${trafficLevel}</p>
                    </div>
                    
                    <div class="loading">
                        <p>Calculando consumo mensual...</p>
                    </div>
                </div>
            `;
            
            document.getElementById('quiz-container').innerHTML = recommendationsHTML;
            
            // Update the header for recommendations view
            document.getElementById('current-step-title').textContent = 'Recomendaciones Personalizadas';
            document.getElementById('progress-info').textContent = 'Resultados Finales';
            
            // Mark all steps as completed
            steps.forEach((step, index) => {
                const stepItem = document.getElementById(`step-item-${index}`);
                if (stepItem) {
                    stepItem.className = 'step-item completed';
                }
            });
            
            // Calcular consumo mensual
            calculateConsumption(segment, trafficLevel, totalEmployees);
        }
        
        async function calculateConsumption(segment, trafficLevel, totalEmployees) {
            try {
                // Preparar referencias seleccionadas para cada producto
                const referencias = {};
                const selectedReferences = {}; // Store the specific reference chosen for each product
                
                companyData.products.forEach(product => {
                    const recommendation = productData[product][segment][trafficLevel];
                    let productReferences = [];
                    
                    if (Array.isArray(recommendation) && recommendation.length > 0) {
                        productReferences = recommendation[0].referencias;
                    } else if (recommendation && recommendation.referencias) {
                        productReferences = recommendation.referencias;
                    }
                    
                    referencias[product] = productReferences;
                    
                    // Select the first RECOMMENDED reference as default (not from API response)
                    if (productReferences.length > 0) {
                        selectedReferences[product] = productReferences[0];
                    }
                });
                
                // Store selected references for UI updates
                companyData.selectedReferences = selectedReferences;
                console.log(selectedReferences);
                const requestData = {
                    numMujeres: companyData.numMujeres,
                    numHombres: companyData.numHombres,
                    diasLaborales: companyData.diasLaborales,
                    horasLaborales: companyData.horasLaborales,
                    tipoPublico: companyData.tipoPublico,
                    sector: companyData.sector,
                    productos: companyData.products,
                    referencias: selectedReferences, // Use specific selected references instead of arrays
                    proporciones: companyData.proporciones || {}, // Incluir proporciones si existen
                    numVisitantes: companyData.numVisitantes || 0 // Incluir n√∫mero de visitantes si existe
                };
                
                const response = await fetch('/api_consultor_integral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error('Error en el c√°lculo de consumo');
                }
                
                const consumptionData = await response.json();
                displayRecommendationsWithConsumption(segment, trafficLevel, consumptionData);
                
            } catch (error) {
                console.error('Error calculando consumo:', error);
                displayRecommendationsWithConsumption(segment, trafficLevel, {});
            }
        }
        
        function displayRecommendationsWithConsumption(segment, trafficLevel, consumptionData) {
            const totalEmployees = companyData.numMujeres + companyData.numHombres;
            
            // Mapear tipos de p√∫blico para mostrar
            const tipoPublicoDisplay = {
                'administrativo': 'Administrativo',
                'operativo': 'Operativo',
                'flotante': 'Flotante'
            };
            
            // Formatear tipos de p√∫blico para mostrar
            let tiposPublicoText = '';
            if (Array.isArray(companyData.tipoPublico)) {
                tiposPublicoText = companyData.tipoPublico
                    .map(tipo => tipoPublicoDisplay[tipo] || tipo)
                    .join(', ');
            } else {
                tiposPublicoText = tipoPublicoDisplay[companyData.tipoPublico] || companyData.tipoPublico;
            }
            
            let recommendationsHTML = `
                <div class="recommendation" id="report-content">
                    <h2>Recomendaciones Personalizadas</h2>                    
                    <div class="company-summary">
                        <h3>Resumen de su Empresa</h3>
                        <p><strong>Sector:</strong> ${companyData.sector}</p>
                        <p><strong>Tama√±o:</strong> ${companyData.size}</p>
                        <p><strong>Total empleados:</strong> ${totalEmployees} (${companyData.numMujeres} mujeres, ${companyData.numHombres} hombres)</p>
                        <p><strong>Jornada laboral:</strong> ${companyData.diasLaborales} d√≠as/mes, ${companyData.horasLaborales} horas/d√≠a</p>
                        <p><strong>Tipos de p√∫blico:</strong> ${tiposPublicoText}</p>
                        <p><strong>Segmento de Ba√±os:</strong> ${segment}</p>
                        <p><strong>Nivel de tr√°fico:</strong> ${trafficLevel}</p>
                    </div>
                    
                    <div class="recommendation-title" style="display: flex; justify-content: center; align-items: center;">
                        <img src="https://essity-images.essity.com/images-c5/785/150785/optimized-w1440_jpg/img-6306.jpg?w=1080&h=100000&imPolicy=dynamic" alt="Imagen del producto" class="product-image" style="width: 540px; height: 360px;">
                    </div>
            `;
            
            // El consumo mensual ahora est√° integrado directamente con cada recomendaci√≥n de producto
            
            // Mostrar recomendaciones de productos con consumo integrado
            companyData.products.forEach(product => {
                const recommendation = productData[product][segment][trafficLevel];
                console.log(recommendation);
                const productConsumption = consumptionData[product];
                
                recommendationsHTML += `<h3 style="color: #1e40af; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 3px solid #1e40af; padding-bottom: 10px;">üì¶ ${product}</h3>`;
                
                // Add selected reference image
                const selectedReference = companyData.selectedReferences ? companyData.selectedReferences[product] : (productConsumption ? productConsumption.referencia_usada : '');
                if (selectedReference) {
                    recommendationsHTML += `
                        <div class="reference-image-container" style="text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; border: 2px solid #cbd5e1;">
                            <h4 style="color: #475569; margin-bottom: 15px; font-weight: 600;">üñºÔ∏è Referencia Seleccionada: ${selectedReference}</h4>
                            <img src="{{ url_for('static', filename='images/') }}${selectedReference}.png" alt="Imagen de referencia ${selectedReference}" 
                                 style="max-width: 300px; max-height: 200px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; padding: 10px; display: block; margin: 0 auto;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; color: #64748b; font-style: italic; padding: 20px;">
                                üì∑ Imagen no disponible para la referencia ${selectedReference}
                            </div>
                        </div>
                    `;
                }
                
                if (Array.isArray(recommendation)) {

                    recommendation.forEach((rec, index) => {
                        recommendationsHTML += `
                            <div class="recommendation-group" style="margin-bottom: 25px;">
                                <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; align-items: start;">
                                    <div>
                                        <h3 style="color: #059669; margin-bottom: 15px;">Opci√≥n ${index + 1}: ${rec.posicionamiento}</h3>
                                        <div style="margin-bottom: 15px;">
                                            <h4 style="color: #1e40af; margin-bottom: 8px;">üìã Referencias:</h4>
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                ${rec.referencias.map(ref => `
                                                    <button type="button" onclick="handleReferenceClick('${ref}', '${product}')" style="background: linear-gradient(135deg, #bfdbfe, #dbeafe); 
                                                                 border: 1px solid #93c5fd; 
                                                                 border-radius: 8px; 
                                                                 padding: 8px 12px; 
                                                                 font-weight: 600; 
                                                                 color: #1e40af; 
                                                                 font-size: 0.95em; 
                                                                 cursor: pointer;">${ref}</button>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <h4 style="color: #1e40af; margin-bottom: 8px;">üè∑Ô∏è Dispensador:</h4>
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                ${rec.dispensador.map(disp => `
                                                    <button type="button" onclick="handleDispenserClick('${disp}')" style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); 
                                                                 border: 1px solid #c4b5fd; 
                                                                 border-radius: 8px; 
                                                                 padding: 8px 12px; 
                                                                 font-weight: 600; 
                                                                 color: #7c3aed; 
                                                                 font-size: 0.95em; 
                                                                 cursor: pointer;">${disp}</button>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${productConsumption && index === 0 ? `
                                        <div class="consumption-item" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
                                                                             border: 2px solid #10b981; 
                                                                             border-radius: 12px; 
                                                                             padding: 20px; 
                                                                             box-shadow: 0 8px 25px rgba(16, 185, 129, 0.1);">
                                            <h4 style="color: #047857; margin: 0 0 15px 0; font-weight: 600; display: flex; align-items: center;">
                                                üìä Consumo Mensual
                                            </h4>
                                            <div class="reference-selector" style="margin: 15px 0; display: flex; flex-direction: column; gap: 10px;">
                                                <label for="ref-${product.replace(/\s/g, '-')}" style="font-weight: 600; color: #047857;">Referencia actual:</label>
                                                <select id="ref-${product.replace(/\s/g, '-')}" data-producto="${product}" 
                                                        style="padding: 8px 12px; border: 2px solid #10b981; border-radius: 8px; background: white; color: #047857;">
                                                    <option value="${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}">${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}</option>
                                                </select>
                                                <button class="recalculate-btn" onclick="recalcularConsumo('${product}')" 
                                                        style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; 
                                                               padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; 
                                                               box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">üîÑ Recalcular</button>
                                            </div>
                                            <p class="consumption-value" id="consumo-${product.replace(/\s/g, '-')}" 
                                               style="font-size: 1.3em; font-weight: 700; color: #059669; margin: 10px 0 0 0;">
                                                ${productConsumption.consumo_mensual} cajas/mes
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {

                    recommendationsHTML += `
                        <div class="recommendation-group" style="margin-bottom: 25px;">
                            <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; align-items: start;">
                                <div>
                                    <h3 style="color: #059669; margin-bottom: 15px;">${recommendation.posicionamiento}</h3>
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: #1e40af; margin-bottom: 8px;">üìã Referencias:</h4>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${recommendation.referencias.map(ref => `
                                                <button type="button" onclick="handleReferenceClick('${ref}', '${product}')" style="background: linear-gradient(135deg, #bfdbfe, #dbeafe); 
                                                             border: 1px solid #93c5fd; 
                                                             border-radius: 8px; 
                                                             padding: 8px 12px; 
                                                             font-weight: 600; 
                                                             color: #1e40af; 
                                                             font-size: 0.95em; 
                                                             cursor: pointer;">${ref}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="color: #1e40af; margin-bottom: 8px;">üè∑Ô∏è Dispensador:</h4>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${recommendation.dispensador.map(disp => `
                                                <button type="button" onclick="handleDispenserClick('${disp}')" style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); 
                                                             border: 1px solid #c4b5fd; 
                                                             border-radius: 8px; 
                                                             padding: 8px 12px; 
                                                             font-weight: 600; 
                                                             color: #7c3aed; 
                                                             font-size: 0.95em; 
                                                             cursor: pointer;">${disp}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                ${productConsumption ? `
                                    <div class="consumption-item" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
                                                                         border: 2px solid #10b981; 
                                                                         border-radius: 12px; 
                                                                         padding: 20px; 
                                                                         box-shadow: 0 8px 25px rgba(16, 185, 129, 0.1);">
                                        <h4 style="color: #047857; margin: 0 0 15px 0; font-weight: 600; display: flex; align-items: center;">
                                            üìä Consumo Mensual
                                        </h4>
                                        <div class="reference-selector" style="margin: 15px 0; display: flex; flex-direction: column; gap: 10px;">
                                            <label for="ref-${product.replace(/\s/g, '-')}" style="font-weight: 600; color: #047857;">Referencia actual:</label>
                                            <select id="ref-${product.replace(/\s/g, '-')}" data-producto="${product}" 
                                                    style="padding: 8px 12px; border: 2px solid #10b981; border-radius: 8px; background: white; color: #047857;">
                                                <option value="${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}">${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}</option>
                                            </select>
                                            <button class="recalculate-btn" onclick="recalcularConsumo('${product}')" 
                                                    style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; 
                                                           padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; 
                                                           box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">üîÑ Recalcular</button>
                                        </div>
                                        <p class="consumption-value" id="consumo-${product.replace(/\s/g, '-')}" 
                                           style="font-size: 1.3em; font-weight: 700; color: #059669; margin: 10px 0 0 0;">
                                            ${productConsumption.consumo_mensual} cajas/mes
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            recommendationsHTML += `
                </div>
                <div class="navigation-buttons">
                    <button class="nav-button btn-prev" onclick="startQuiz()">Comenzar de Nuevo</button>
                    <button class="nav-button btn-next" onclick="generatePDF()">Generar Reporte</button>
                </div>
            `;
            
            document.getElementById('quiz-container').innerHTML = recommendationsHTML;
            
            // Cargar referencias para cada producto despu√©s de renderizar
            if (Object.keys(consumptionData).length > 0) {
                Object.keys(consumptionData).forEach(producto => {
                    loadReferencesForProduct(producto);
                });
            }
        }
        
        async function loadReferencesForProduct(producto) {
            try {
                const response = await fetch('/api_get_referencias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ producto })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const selectId = `ref-${producto.replace(/\s/g, '-')}`;
                    const select = document.getElementById(selectId);
                    
                    if (select && data.referencias) {
                        // Get recommended references for this product
                        const segment = companyData.bathroomSegment;
                        const totalEmployees = companyData.numMujeres + companyData.numHombres;
                        const trafficLevel = determineTrafficLevel(totalEmployees, companyData.diasLaborales, companyData.horasLaborales);
                        
                        let recommendedRefs = [];
                        const recommendation = productData[producto][segment][trafficLevel];
                        
                        if (Array.isArray(recommendation)) {
                            // If multiple recommendations, collect all references
                            recommendation.forEach(rec => {
                                recommendedRefs = recommendedRefs.concat(rec.referencias);
                            });
                        } else if (recommendation && recommendation.referencias) {
                            recommendedRefs = recommendation.referencias;
                        }
                        
                        // Remove duplicates
                        recommendedRefs = [...new Set(recommendedRefs)];
                        
                        // Limpiar opciones existentes excepto la primera (actual)
                        const currentValue = select.value;
                        select.innerHTML = '';
                        
                        // Get the specific selected reference for this product
                        const selectedReference = companyData.selectedReferences ? companyData.selectedReferences[producto] : null;
                        
                        // Sort references: selected reference first, then other recommended, then others
                        const sortedRefs = data.referencias.sort((a, b) => {
                            const aIsSelected = selectedReference && (a === selectedReference || a.startsWith(selectedReference + ' -'));
                            const bIsSelected = selectedReference && (b === selectedReference || b.startsWith(selectedReference + ' -'));
                            const aIsRecommended = recommendedRefs.includes(a);
                            const bIsRecommended = recommendedRefs.includes(b);
                            
                            // Selected reference goes first
                            if (aIsSelected && !bIsSelected) return -1;
                            if (!aIsSelected && bIsSelected) return 1;
                            
                            // If both or neither are selected, sort by recommendation status
                            if (aIsRecommended && !bIsRecommended) return -1;
                            if (!aIsRecommended && bIsRecommended) return 1;
                            return 0;
                        });
                        
                        // A√±adir todas las referencias con highlighting
                        sortedRefs.forEach(ref => {
                            const option = document.createElement('option');
                            option.value = ref;
                            
                            // Highlight recommended references
                            if (recommendedRefs.includes(ref)) {
                                option.textContent = `‚≠ê ${ref} (Recomendado)`;
                            } else {
                                option.textContent = ref;
                            }
                            
                            option.selected = ref === currentValue;
                            select.appendChild(option);
                        });
                        
                        // Initialize Selectize after populating options
                        $(select).selectize({
                            searchField: ['text', 'value'],
                            maxItems: 1,
                            create: false,
                            sortField: 'text',
                            onChange: function(value) {
                                // Handle selection change if needed
                                console.log('Selectize value changed to:', value);
                                
                                // Update reference image when dropdown selection changes
                                if (value) {
                                    const producto = this.$input.data('producto');
                                    if (producto) {
                                        // Extract just the reference number from the full value (in case it has description)
                                        const referenceMatch = value.match(/^(\d+)/);
                                        const referenceNumber = referenceMatch ? referenceMatch[1] : value;
                                        updateReferenceImage(producto, referenceNumber);
                                    }
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error cargando referencias:', error);
            }
        }
        
        function displaySelected(producto) {
            console.log(producto);
            const selectId = `ref-${producto.replace(/\s/g, '-')}`;
            const select = document.getElementById(selectId);
            
            if (select && companyData.selectedReferences && companyData.selectedReferences[producto]) {
                const recommendedReference = companyData.selectedReferences[producto];
                console.log("referencia seleccionada", recommendedReference);
                
                // Find and move the recommended reference to the first position
                const options = Array.from(select.options);
                let recommendedOption = null;
                let recommendedIndex = -1;
                
                // Find the recommended option
                for (let i = 0; i < options.length; i++) {
                    const optionValue = options[i].value;
                    if (optionValue.startsWith(recommendedReference + ' -') || optionValue === recommendedReference) {
                        recommendedOption = options[i];
                        recommendedIndex = i;
                        break;
                    }
                }
                
                // If found, move it to the first position
                if (recommendedOption && recommendedIndex > 0) {
                    // Remove the option from its current position
                    select.removeChild(recommendedOption);
                    // Insert it at the beginning
                    select.insertBefore(recommendedOption, select.firstChild);
                }
                
                // Force refresh the select element
                select.style.display = 'none';
                select.offsetHeight; // Trigger reflow
                select.style.display = 'block';
            }
        }
        
        async function recalcularConsumo(producto, fromReferenceClick = false) {
            const selectId = `ref-${producto.replace(/\s/g, '-')}`;
            const consumoId = `consumo-${producto.replace(/\s/g, '-')}`;
            const select = document.getElementById(selectId);
            const consumoElement = document.getElementById(consumoId);
            
            if (!select || !consumoElement) return;
            
            const nuevaReferencia = select.value;
            let buttonElement = null;
            
            // Only handle button if called from button click (not from reference click)
            if (!fromReferenceClick && event && event.target) {
                buttonElement = event.target;
                // Mostrar estado de carga
                buttonElement.disabled = true;
                buttonElement.innerHTML = '‚è≥ Calculando...';
            }
            
            consumoElement.innerHTML = 'Calculando...';
            
            try {
                const requestData = {
                    numMujeres: companyData.numMujeres,
                    numHombres: companyData.numHombres,
                    diasLaborales: companyData.diasLaborales,
                    horasLaborales: companyData.horasLaborales,
                    tipoPublico: companyData.tipoPublico,
                    sector: companyData.sector,
                    producto: producto,
                    referencia: nuevaReferencia,
                    proporciones: companyData.proporciones || {}, // Incluir proporciones si existen
                    numVisitantes: companyData.numVisitantes || 0 // Incluir n√∫mero de visitantes si existe
                };
                
                const response = await fetch('/api_recalcular_consumo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.error) {
                        consumoElement.innerHTML = 'Error en el c√°lculo';
                        alert('Error: ' + data.error);
                    } else {
                        consumoElement.innerHTML = `${data.consumo_mensual} cajas/mes`;
                    }
                } else {
                    consumoElement.innerHTML = 'Error en el c√°lculo';
                    alert('Error al recalcular el consumo');
                }
            } catch (error) {
                console.error('Error recalculando consumo:', error);
                consumoElement.innerHTML = 'Error en el c√°lculo';
                alert('Error de conexi√≥n al recalcular');
            } finally {
                // Only restore button if it was a button click
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = 'üîÑ Recalcular';
                }
            }
        }
        
        // Nueva funci√≥n para generar el PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const element = document.getElementById('report-content');
            
            // Ocultar botones de navegaci√≥n antes de la captura
            const navButtons = document.querySelector('.navigation-buttons');
            navButtons.style.display = 'none';

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; 
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const filename = `Reporte_${companyData.sector.replace(/\s/g, '_')}.pdf`;
                doc.save(filename);
                
                // Mostrar botones de navegaci√≥n de nuevo
                navButtons.style.display = 'flex';
            });
        }
        
        // Function to update reference image when reference is selected
        function updateReferenceImage(productName, referenceText) {
            // Find all reference image containers for this product
            const productHeading = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes(`üì¶ ${productName}`));
            if (productHeading) {
                const imageContainer = productHeading.nextElementSibling;
                if (imageContainer && imageContainer.className && imageContainer.className.includes('reference-image-container')) {
                    // Update the heading
                    const heading = imageContainer.querySelector('h4');
                    if (heading) {
                        heading.textContent = `üñºÔ∏è Referencia Seleccionada: ${referenceText}`;
                    }
                    
                    // Update the image
                    const img = imageContainer.querySelector('img');
                    const fallback = imageContainer.querySelector('div[style*="display: none"]');
                    if (img && fallback) {
                        img.src = `{{ url_for('static', filename='images/') }}${referenceText}.png`;
                        img.alt = `Imagen de referencia ${referenceText}`;
                        img.style.display = 'block';
                        img.style.margin = '0 auto';
                        fallback.style.display = 'none';
                        fallback.innerHTML = `üì∑ Imagen no disponible para la referencia ${referenceText}`;
                    }
                }
            }
        }

        // Method to handle reference button clicks
        function handleReferenceClick(referenceText, productName) {
            console.log('Reference clicked:', referenceText, 'for product:', productName);
            
            // Find the corresponding select element
            const selectId = `ref-${productName.replace(/\s/g, '-')}`;
            const selectElement = document.getElementById(selectId);
            
            if (selectElement) {
                // Get the Selectize instance
                const selectizeInstance = selectElement.selectize;
                
                if (selectizeInstance) {
                    // Use Selectize API to find and set value
                    let foundValue = null;
                    
                    // First try exact match
                    if (selectizeInstance.options[referenceText]) {
                        foundValue = referenceText;
                    } else {
                        // Look for partial match in all options
                        for (let optionValue in selectizeInstance.options) {
                            if (optionValue.startsWith(referenceText + ' -') || 
                                optionValue.includes(referenceText)) {
                                foundValue = optionValue;
                                break;
                            }
                        }
                    }
                    
                    if (foundValue) {
                        // Set the value using Selectize API
                        selectizeInstance.setValue(foundValue, false); // false = don't trigger change event
                        
                        console.log('Selected reference updated to:', foundValue);
                        
                        // Update the reference image
                        updateReferenceImage(productName, referenceText);
                        
                        // Manually trigger recalculation since we suppressed the change event
                        recalcularConsumo(productName, true);
                    } else {
                        console.log('No matching option found for reference:', referenceText);
                        console.log('Available options:', Object.keys(selectizeInstance.options));
                    }
                } else {
                    // Fallback to native select if Selectize not initialized
                    console.log('Selectize not found, using native select');
                    
                    let foundOption = false;
                    
                    // First try exact match
                    for (let option of selectElement.options) {
                        if (option.value === referenceText) {
                            selectElement.value = referenceText;
                            foundOption = true;
                            break;
                        }
                    }
                    
                    // If exact match not found, look for partial match
                    if (!foundOption) {
                        for (let option of selectElement.options) {
                            if (option.value.startsWith(referenceText + ' -') || 
                                option.value.includes(referenceText)) {
                                selectElement.value = option.value;
                                foundOption = true;
                                break;
                            }
                        }
                    }
                    
                    if (foundOption) {
                        console.log('Selected reference updated to:', selectElement.value);
                        // Update the reference image
                        updateReferenceImage(productName, referenceText);
                        recalcularConsumo(productName, true);
                    }
                }
            } else {
                console.log('Select element not found:', selectId);
            }
        }
        
        function handleDispenserClick(dispenserText) {
            console.log('Dispenser clicked:', dispenserText);
        }
        
        function startQuiz() {
            currentStep = 0;
            companyData = {};
            selectedProducts = [];
            selectedPublicTypes = [];
            selectedBathroomSegment = '';
            initializeStepsList();
            renderStep();
        }
        
        // Inicializar el cuestionario
        document.addEventListener('DOMContentLoaded', function() {
            startQuiz();
        });
    </script>
</body>
</html>
