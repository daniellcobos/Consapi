<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultor Integral - Tork Solutions</title>
    <!-- CSS principal -->
    <link rel="stylesheet" href="{{ url_for('static', filename='consultor_integral.css') }}">

    <!-- Bootstrap utilities (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap-utilities.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- jQuery (required for Selectize) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Selectize -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.default.min.css"
        integrity="sha512-pTaEn+6gF1IeWv3W1+7X7eM60TFu/agjgoHmYhAfLEU8Phuf6JKiiE8YmsNC0aCgQv4192s4Vai8YZ6VNM6vyQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/js/selectize.min.js"
        integrity="sha512-IOebNkvA/HZjMM7MxL0NYeLYEalloZ8ckak+NDtOViP7oiYzG5vn6WVXyrJDiJPhl4yRdmNAG49iuLmhkUdVsQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="ci-page">
    <div class="container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='images/tork_think-ahead_vertical.png') }}"
                     alt="Tork - Think ahead"
                     style="max-width: 180px; height: auto; margin-bottom: 20px;">
                <h1>Consultor Integral</h1>
                <p>Encuentra las mejores soluciones de higiene para tu empresa</p>
            </div>
            <div class="steps-list" id="steps-list">
                <!-- Los pasos se generar√°n din√°micamente -->
            </div>
        </div>
        
        <!-- Right Content -->
        <div class="right-content">
            <div class="content-header">
                <h2 id="current-step-title">Informaci√≥n de la Empresa</h2>
                <p class="progress-info" id="progress-info">Paso 1 de 4</p>
            </div>
            
            <div class="quiz-content">
                <div id="quiz-container">
                    <!-- El contenido se generar√° din√°micamente aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos de la empresa del usuario
        let companyData = {};
        let consumptionData = {};
        
        // Datos de segmentaci√≥n de productos (cargados din√°micamente desde Portfolio.xlsx)
        let productData = {};

        // Cargar datos de productos desde Portfolio.xlsx
        async function loadProductData() {
            try {
                const response = await fetch('/api_portfolio_data');
                if (response.ok) {
                    productData = await response.json();
                    console.log('Portfolio data loaded successfully:', productData);
                } else {
                    console.error('Error loading portfolio data:', response.status);
                    // Volver a datos vac√≠os o mostrar error
                    productData = {};
                }
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
                productData = {};
            }
        }
        
        // Estado del cuestionario
        let currentStep = 0;
        let selectedProducts = [];
        let selectedPublicTypes = [];
        let selectedBathroomSegment = '';
        
        // Definici√≥n de pasos del cuestionario
        const steps = [
            {
                id: 'company-sector',
                title: 'Informaci√≥n de la Empresa',
                shortTitle: 'Empresa',
                icon: '',
                description: '¬øPor qu√© necesitamos esta informaci√≥n?',
                justification: 'El sector de su empresa y su tama√±o determinan las necesidades espec√≠ficas de higiene. Por ejemplo, el sector salud requiere est√°ndares de higiene cr√≠tica, mientras que empresas m√°s grandes necesitan soluciones de mayor capacidad y eficiencia.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© necesitamos esta informaci√≥n?</h4>
                            <p>El sector de su empresa y su tama√±o determinan las necesidades espec√≠ficas de higiene. Por ejemplo, el sector salud requiere est√°ndares de higiene cr√≠tica, mientras que empresas m√°s grandes necesitan soluciones de mayor capacidad y eficiencia.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companySector">Sector de la empresa:</label>
                        <select id="companySector" required>
                            <option value="">-- Selecciona un sector --</option>
                            <option value="Oficinas / Corporativo">Oficinas / Corporativo</option>
                            <option value="Industria / Manufactura">Industria / Manufactura</option>
                            <option value="Salud (Hospitales, Cl√≠nicas)">Salud (Hospitales, Cl√≠nicas)</option>
                            <option value="Educaci√≥n (Colegios, Universidades)">Educaci√≥n (Colegios, Universidades)</option>
                            <option value="HoReCa (Hoteles, Restaurantes, Cafeter√≠as)">HoReCa (Hoteles, Restaurantes, Cafeter√≠as)</option>
                            <option value="Retail / Comercio">Retail / Comercio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="companySize">Tama√±o de la empresa (n√∫mero de empleados):</label>
                        <select id="companySize" required>
                            <option value="">-- Selecciona el tama√±o --</option>                        
                            <option value="11-50">Peque√±a 11-50 empleados</option>
                            <option value="51-200">Mediana 51-200 empleados</option>
                            <option value="200+">Grande M√°s de 500 empleados</option>
                        </select>
                    </div>
                `
            },
            {
                id: 'demographics',
                title: 'Demograf√≠a y Jornada Laboral',
                shortTitle: 'Demograf√≠a',
                icon: '',
                description: '¬øPor qu√© preguntamos sobre demograf√≠a?',
                justification: 'Los patrones de uso var√≠an entre g√©neros y la intensidad de trabajo afecta la frecuencia de uso de los productos. Esta informaci√≥n nos permite calcular el consumo mensual exacto y recomendar la capacidad de dispensadores adecuada.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© preguntamos sobre demograf√≠a?</h4>
                            <p>Los patrones de uso var√≠an entre g√©neros y la intensidad de trabajo afecta la frecuencia de uso de los productos. Esta informaci√≥n nos permite calcular el consumo mensual exacto y recomendar la capacidad de dispensadores adecuada.</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="numMujeres">N√∫mero de mujeres:</label>
                        <input type="number" id="numMujeres" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="numHombres">N√∫mero de hombres:</label>
                        <input type="number" id="numHombres" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="diasLaborales">D√≠as laborales por mes:</label>
                        <input type="number" id="diasLaborales" min="1" max="31" value="30" required>
                    </div>
                    <div class="form-group">
                        <label for="horasLaborales">Horas laborales por d√≠a:</label>
                        <input type="number" id="horasLaborales" min="1" max="24" value="8" required>
                    </div>
                `
            },
            {
                id: 'public-type',
                title: 'Tipo de P√∫blico',
                shortTitle: 'P√∫blico',
                icon: '',
                description: '¬øPor qu√© es importante el tipo de p√∫blico?',
                justification: 'Diferentes tipos de usuarios tienen distintos patrones de consumo y expectativas de calidad. El personal administrativo y los visitantes esperan mayor comodidad, mientras que el personal operativo necesita productos m√°s resistentes. Esta clasificaci√≥n nos ayuda a determinar el segmento de producto m√°s apropiado.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© es importante el tipo de p√∫blico?</h4>
                            <p>Diferentes tipos de usuarios tienen distintos patrones de consumo y expectativas de calidad. El personal administrativo y los visitantes esperan mayor comodidad, mientras que el personal operativo necesita productos m√°s resistentes. Esta clasificaci√≥n nos ayuda a determinar el segmento de producto m√°s apropiado.</p>
                        </div>
                    </div>
                    <p>¬øQu√© tipos de p√∫blico visitan sus instalaciones? (Puede seleccionar m√∫ltiples opciones)</p>
                    <div class="options-container">
                        <button type="button" class="option-button public-option" data-public="administrativo">
                            <strong>Administrativo</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Personal de oficina, gerentes, empleados de escritorio</span>
                        </button>
                        <button type="button" class="option-button public-option" data-public="operativo">
                            <strong>Operativo</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Personal de producci√≥n, t√©cnicos, trabajadores de campo</span>
                        </button>
                        <button type="button" class="option-button public-option" data-public="flotante">
                            <strong>Flotante</strong><br>
                            <span style="font-size: 0.9em; font-weight: normal;">Visitantes, clientes, personal temporal o externo</span>
                        </button>
                    </div>
                    
                    <div id="proporcion-container" class="hidden" style="margin-top: 30px;">
                        <div class="description-box">
                            <h4>Distribuci√≥n de P√∫blico</h4>
                            <p>Por favor, especifique la proporci√≥n de cada tipo de p√∫blico en su empresa (debe sumar 100%):</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div class="form-group" id="proporcion-administrativo" style="display: none;">
                                <label for="prop-administrativo" style="color: #00205b;">Administrativo (%):</label>
                                <input type="number" id="prop-administrativo" min="0" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                            
                            <div class="form-group" id="proporcion-operativo" style="display: none;">
                                <label for="prop-operativo" style="color: #00205b;">Operativo (%):</label>
                                <input type="number" id="prop-operativo" min="0" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <p id="total-porcentaje" style="font-weight: 600; color: #00853F;">Total: 100%</p>
                        </div>
                    </div>
                    
                    <div id="visitantes-container" class="hidden" style="margin-top: 30px;">
                        <div class="description-box">
                            <h4>Visitantes Flotantes</h4>
                            <p>Por favor, especifique el n√∫mero estimado de visitantes diarios que utilizan las instalaciones:</p>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="num-visitantes" style="color: #00205b;">N√∫mero estimado de visitantes por d√≠a:</label>
                            <input type="number" id="num-visitantes" min="0" value="50" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; max-width: 300px;">
                        </div>
                    </div>
                `
            },
            {
                id: 'product-selection',
                title: 'Selecci√≥n de Productos y Segmento',
                shortTitle: 'Productos',
                icon: 'üßª',
                description: '¬øPor qu√© seleccionar productos y segmento espec√≠ficos?',
                justification: 'Cada producto tiene diferentes especificaciones t√©cnicas, frecuencias de uso y m√©todos de dispensaci√≥n. El segmento de ba√±o determina el nivel de calidad y experiencia del usuario. Esta informaci√≥n nos permite ofrecer recomendaciones precisas de referencias, dispensadores y calcular el consumo mensual espec√≠fico.',
                content: `
                    <div class="step-description">
                        <div class="description-box">
                            <h4>¬øPor qu√© seleccionar productos y segmento espec√≠ficos?</h4>
                            <p>Cada producto tiene diferentes especificaciones t√©cnicas, frecuencias de uso y m√©todos de dispensaci√≥n. El segmento de ba√±o determina el nivel de calidad y experiencia del usuario. Esta informaci√≥n nos permite ofrecer recomendaciones precisas de referencias, dispensadores y calcular el consumo mensual espec√≠fico.</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #00205b; margin-bottom: 15px; font-size: 1.3em;">Productos de Higiene</h3>
                        <p>¬øQu√© productos de higiene necesita su empresa? (Puede seleccionar m√∫ltiples opciones)</p>
                        <div class="options-container">
                            <button type="button" class="option-button product-option" data-product="Papel Higi√©nico">Papel Higi√©nico</button>
                            <button type="button" class="option-button product-option" data-product="Toallas de Manos">Toallas de Manos</button>
                            <button type="button" class="option-button product-option" data-product="Jabones y Gel">Jabones y Gel</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #00205b; margin-bottom: 15px; font-size: 1.3em;">Segmento de Ba√±os</h3>
                        <p>Seleccione el segmento que mejor describe las expectativas y necesidades de sus ba√±os:</p>
                        <div class="options-container">
                            <button type="button" class="option-button segment-option" data-segment="Essential">
                                <strong>Essential</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Funcionalidad b√°sica y costo-efectivo</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Restroom Plus">
                                <strong>Restroom Plus</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Calidad mejorada y mayor comodidad</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Wow Factor">
                                <strong>Wow Factor</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">Experiencia premium y m√°xima satisfacci√≥n</span>
                            </button>
                            <button type="button" class="option-button segment-option" data-segment="Higiene Cr√≠tica">
                                <strong>Higiene Cr√≠tica</strong><br>
                                <span style="font-size: 0.9em; font-weight: normal;">M√°ximos est√°ndares sanitarios y seguridad</span>
                            </button>
                        </div>
                    </div>
                `
            }
        ];
        
        function initializeStepsList() {
            const container = document.getElementById('steps-list');
            container.innerHTML = '';
            
            steps.forEach((step, index) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';
                stepItem.id = `step-item-${index}`;
                
                stepItem.innerHTML = `
                    <div class="step-content-title">
                        <span class="step-number">${index + 1}</span>
                        ${step.shortTitle}
                    </div>
                    <div class="step-description-text">
                        ${step.justification.substring(0, 100)}...
                    </div>
                `;
                
                container.appendChild(stepItem);
            });
            
            updateStepsList();
        }
        
        function updateStepsList() {
            steps.forEach((step, index) => {
                const stepItem = document.getElementById(`step-item-${index}`);
                
                // Reiniciar clases
                stepItem.className = 'step-item';
                
                if (index < currentStep) {
                    // Paso completado
                    stepItem.classList.add('completed');
                } else if (index === currentStep) {
                    // Paso activo
                    stepItem.classList.add('active');
                } else {
                    // Paso futuro - mantener estilo por defecto
                }
            });
        }

        function updateProgress() {
            updateStepsList();
            
            // Actualizar encabezado de contenido
            const step = steps[currentStep];
            document.getElementById('current-step-title').textContent = step.title;
            document.getElementById('progress-info').textContent = `Paso ${currentStep + 1} de ${steps.length}`;
        }
        
        function renderStep() {
            const step = steps[currentStep];
            const container = document.getElementById('quiz-container');

            container.innerHTML = `
                ${step.content}
                <div class="navigation-buttons">
                    <button class="nav-button btn-prev" onclick="previousStep()" ${currentStep === 0 ? 'style="visibility: hidden;"' : ''}>
                        Anterior
                    </button>
                    <button class="nav-button btn-next" onclick="nextStep()" id="next-btn">
                        ${currentStep === steps.length - 1 ? 'Generar Recomendaciones' : 'Siguiente'}
                    </button>
                </div>
            `;

            updateProgress();
            attachEventListeners();

            // Scroll to current step title on mobile
            if (window.innerWidth <= 768) {
                const stepTitle = document.getElementById('current-step-title');
                if (stepTitle) {
                    stepTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
        
        function attachEventListeners() {
            // Event listeners para selecci√≥n de productos
            document.querySelectorAll('.product-option').forEach(button => {
                button.addEventListener('click', function() {
                    const product = this.dataset.product;
                    if (selectedProducts.includes(product)) {
                        selectedProducts = selectedProducts.filter(p => p !== product);
                        this.style.background = '#0070C0';
                    } else {
                        selectedProducts.push(product);
                        this.style.background = '#00205b';
                    }
                });
            });

            // Event listeners para selecci√≥n de tipos de p√∫blico
            document.querySelectorAll('.public-option').forEach(button => {
                button.addEventListener('click', function() {
                    const publicType = this.dataset.public;
                    if (selectedPublicTypes.includes(publicType)) {
                        selectedPublicTypes = selectedPublicTypes.filter(p => p !== publicType);
                        this.style.background = '#0070C0';
                    } else {
                        selectedPublicTypes.push(publicType);
                        this.style.background = '#00205b';
                    }

                    // Mostrar/ocultar inputs de proporci√≥n
                    updateProporcionInputs();
                });
            });

            // Event listeners para los inputs de proporci√≥n
            const propAdm = document.getElementById('prop-administrativo');
            const propOp = document.getElementById('prop-operativo');
            if (propAdm && propOp) {
                [propAdm, propOp].forEach(input => {
                    input.addEventListener('input', updateTotalPorcentaje);
                });
            }

            // Event listeners para validaci√≥n de demograf√≠a
            const numMujeres = document.getElementById('numMujeres');
            const numHombres = document.getElementById('numHombres');
            if (numMujeres && numHombres) {
                [numMujeres, numHombres].forEach(input => {
                    input.addEventListener('input', validateDemographicsStep);
                });
                // Validar al cargar el paso
                validateDemographicsStep();
            }

            // Event listeners para selecci√≥n de segmento de ba√±os
            document.querySelectorAll('.segment-option').forEach(button => {
                button.addEventListener('click', function() {
                    const segment = this.dataset.segment;

                    // Reiniciar todos los botones de segmento al estilo por defecto
                    document.querySelectorAll('.segment-option').forEach(btn => {
                        btn.style.background = '#0070C0';
                    });

                    // Establecer el segmento seleccionado
                    selectedBathroomSegment = segment;
                    this.style.background = '#00205b';
                });
            });
        }

        function validateDemographicsStep() {
            const numMujeres = document.getElementById('numMujeres');
            const numHombres = document.getElementById('numHombres');
            const nextBtn = document.getElementById('next-btn');

            if (numMujeres && numHombres && nextBtn) {
                const mujeres = parseInt(numMujeres.value) || 0;
                const hombres = parseInt(numHombres.value) || 0;

                if (mujeres > 0 || hombres > 0) {
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                    nextBtn.style.cursor = 'pointer';
                } else {
                    nextBtn.disabled = true;
                    nextBtn.style.opacity = '0.5';
                    nextBtn.style.cursor = 'not-allowed';
                }
            }
        }
        
        function updateProporcionInputs() {
            const proporcionContainer = document.getElementById('proporcion-container');
            const visitantesContainer = document.getElementById('visitantes-container');
            const propAdmContainer = document.getElementById('proporcion-administrativo');
            const propOpContainer = document.getElementById('proporcion-operativo');
            
            // Verificar qu√© tipos de p√∫blico est√°n seleccionados
            const hasAdministrativo = selectedPublicTypes.includes('administrativo');
            const hasOperativo = selectedPublicTypes.includes('operativo');
            const hasFlotante = selectedPublicTypes.includes('flotante');
            
            // Mostrar inputs de proporci√≥n cuando administrativo y operativo est√©n seleccionados
            if (hasAdministrativo && hasOperativo) {
                proporcionContainer.classList.remove('hidden');
                propAdmContainer.style.display = 'block';
                propOpContainer.style.display = 'block';
                updateTotalPorcentaje();
            } else {
                proporcionContainer.classList.add('hidden');
                propAdmContainer.style.display = 'none';
                propOpContainer.style.display = 'none';
            }
            
            // Mostrar input de visitantes cuando flotante est√© seleccionado
            if (hasFlotante) {
                visitantesContainer.classList.remove('hidden');
            } else {
                visitantesContainer.classList.add('hidden');
            }
        }
        
        function updateTotalPorcentaje() {
            const propAdm = parseInt(document.getElementById('prop-administrativo').value) || 0;
            const propOp = parseInt(document.getElementById('prop-operativo').value) || 0;
            const total = propAdm + propOp;
            
            const totalElement = document.getElementById('total-porcentaje');
            totalElement.textContent = `Total: ${total}%`;
            
            if (total === 100) {
                totalElement.style.color = '#059669';
            } else if (total > 100) {
                totalElement.style.color = '#dc2626';
            } else {
                totalElement.style.color = '#00853F';
            }
        }
        
        function validateStep() {
            const stepId = steps[currentStep].id;
            
            switch(stepId) {
                case 'company-sector':
                    const sector = document.getElementById('companySector').value;
                    const size = document.getElementById('companySize').value;
                    if (!sector || !size) return false;
                    companyData.sector = sector;
                    companyData.size = size;
                    break;
                    
                case 'demographics':
                    const mujeres = document.getElementById('numMujeres').value;
                    const hombres = document.getElementById('numHombres').value;
                    const dias = document.getElementById('diasLaborales').value;
                    const horas = document.getElementById('horasLaborales').value;
                    if (!mujeres || !hombres || !dias || !horas) return false;
                    companyData.numMujeres = parseInt(mujeres);
                    companyData.numHombres = parseInt(hombres);
                    companyData.diasLaborales = parseInt(dias);
                    companyData.horasLaborales = parseInt(horas);
                    break;
                    
                case 'public-type':
                    if (selectedPublicTypes.length === 0) return false;
                    
                    // Verificar qu√© tipos de p√∫blico est√°n seleccionados
                    const hasAdministrativo = selectedPublicTypes.includes('administrativo');
                    const hasOperativo = selectedPublicTypes.includes('operativo');
                    const hasFlotante = selectedPublicTypes.includes('flotante');
                    
                    // Validar proporciones cuando administrativo y operativo est√©n seleccionados
                    if (hasAdministrativo && hasOperativo) {
                        const propAdm = parseInt(document.getElementById('prop-administrativo').value) || 0;
                        const propOp = parseInt(document.getElementById('prop-operativo').value) || 0;
                        
                        if (propAdm + propOp !== 100) {
                            alert('Las proporciones deben sumar exactamente 100%');
                            return false;
                        }
                        
                        // Guardar proporciones en companyData
                        companyData.proporciones = {
                            administrativo: propAdm,
                            operativo: propOp
                        };
                    }
                    
                    // Validar cantidad de visitantes cuando flotante est√© seleccionado
                    if (hasFlotante) {
                        const numVisitantes = parseInt(document.getElementById('num-visitantes').value);
                        if (!numVisitantes || numVisitantes <= 0) {
                            alert('Debe ingresar un n√∫mero v√°lido de visitantes diarios');
                            return false;
                        }
                        
                        // Guardar cantidad de visitantes en companyData
                        companyData.numVisitantes = numVisitantes;
                    }
                    
                    companyData.tipoPublico = selectedPublicTypes;
                    break;
                    
                case 'product-selection':
                    if (selectedProducts.length === 0) return false;
                    if (!selectedBathroomSegment) return false;
                    companyData.products = selectedProducts;
                    companyData.bathroomSegment = selectedBathroomSegment;
                    break;
            }
            
            return true;
        }
        
        function nextStep() {
            if (!validateStep()) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }
            
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep();
            } else {
                generateRecommendations();
            }
        }
        
        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }
        
        function determineTrafficLevel(numEmployees, diasLaborales, horasLaborales) {
            // Calcular intensidad de uso basada en empleados, d√≠as y horas laborales
            
            // Factor de intensidad horaria (horas/d√≠a)
            let intensityFactor = 1;
            if (horasLaborales >= 16) {
                intensityFactor = 1.5; // Turnos de 24 horas o m√∫ltiples turnos
            } else if (horasLaborales >= 12) {
                intensityFactor = 1.3; // Jornadas extendidas
            } else if (horasLaborales >= 8) {
                intensityFactor = 1.0; // Jornada normal
            } else {
                intensityFactor = 0.8; // Jornadas reducidas
            }
            
            // Factor de frecuencia mensual (d√≠as/mes)
            let frequencyFactor = 1;
            if (diasLaborales >= 28) {
                frequencyFactor = 1.4; // Operaci√≥n casi continua
            } else if (diasLaborales >= 22) {
                frequencyFactor = 1.2; // Operaci√≥n intensa (m√°s de 5 d√≠as/semana)
            } else if (diasLaborales >= 20) {
                frequencyFactor = 1.0; // Operaci√≥n est√°ndar (5 d√≠as/semana)
            } else if (diasLaborales >= 15) {
                frequencyFactor = 0.8; // Operaci√≥n reducida
            } else {
                frequencyFactor = 0.6; // Operaci√≥n muy reducida
            }
            
            // √çndice de tr√°fico ajustado
            const adjustedTrafficIndex = numEmployees * intensityFactor * frequencyFactor;
            
            // Clasificaci√≥n basada en el √≠ndice ajustado
            if (adjustedTrafficIndex < 40) return "Tr√°fico Bajo";
            if (adjustedTrafficIndex < 180) return "Tr√°fico Medio";
            if (adjustedTrafficIndex < 450) return "Tr√°fico Alto";
            return "Tr√°fico Pico";
        }
        
        function determineSegment(sector, size, tiposPublico) {
            // L√≥gica para determinar el segmento basado en sector, tama√±o y tipos de p√∫blico
            if (sector === 'Salud (Hospitales, Cl√≠nicas)') return 'Higiene Cr√≠tica';
            if (sector === 'HoReCa (Hoteles, Restaurantes, Cafeter√≠as)') return 'Higiene Cr√≠tica';
            
            // Considerar si hay tipo de p√∫blico flotante para segmentaci√≥n premium
            const hasFlotante = Array.isArray(tiposPublico) ? tiposPublico.includes('flotante') : tiposPublico === 'flotante';
            const hasMultipleTypes = Array.isArray(tiposPublico) && tiposPublico.length > 1;
            
            // Segmentaci√≥n premium para p√∫blico flotante o m√∫ltiples tipos
            if ((hasFlotante || hasMultipleTypes) && size === '200+') return 'Wow Factor';
            if ((hasFlotante || hasMultipleTypes) && (size === '51-200' || size === '11-50')) return 'Restroom Plus';
            
            if (size === '200+') return 'Wow Factor';
            if (size === '51-200') return 'Restroom Plus';
            return 'Essential';
        }
        
        function generateRecommendations() {
            const totalEmployees = companyData.numMujeres + companyData.numHombres;
            const trafficLevel = determineTrafficLevel(totalEmployees, companyData.diasLaborales, companyData.horasLaborales);
            const segment = companyData.bathroomSegment; // Use user-selected segment

            // Scroll to top on mobile to prevent viewport jumping
            if (window.innerWidth <= 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            let recommendationsHTML = `
                <div class="recommendation" id="report-content">
                    <h2>Recomendaciones Personalizadas</h2>

                    <div class="company-summary">
                        <h3>Resumen de su Empresa</h3>
                        <p><strong>Sector:</strong> ${companyData.sector}</p>
                        <p><strong>Tama√±o:</strong> ${companyData.size}</p>
                        <p><strong>Total empleados:</strong> ${totalEmployees} (${companyData.numMujeres} mujeres, ${companyData.numHombres} hombres)</p>
                        <p><strong>Jornada laboral:</strong> ${companyData.diasLaborales} d√≠as/mes, ${companyData.horasLaborales} horas/d√≠a</p>
                        <p><strong>Tipo de p√∫blico:</strong> ${companyData.tipoPublico}</p>
                        <p><strong>Segmento seleccionado:</strong> ${segment}</p>
                        <p><strong>Nivel de tr√°fico:</strong> ${trafficLevel}</p>
                    </div>

                    <div class="loading">
                        <p>Calculando consumo mensual...</p>
                    </div>
                </div>
            `;

            document.getElementById('quiz-container').innerHTML = recommendationsHTML;




            // Mark all steps as completed
            steps.forEach((step, index) => {
                const stepItem = document.getElementById(`step-item-${index}`);
                if (stepItem) {
                    stepItem.className = 'step-item completed';
                }
            });

            // Calcular consumo mensual
            calculateConsumption(segment, trafficLevel, totalEmployees);
        }
        
        async function calculateConsumption(segment, trafficLevel, totalEmployees) {
            try {
                // Preparar referencias seleccionadas para cada producto
                const referencias = {};
                const selectedReferences = {}; // Store the specific reference chosen for each product

                companyData.products.forEach(product => {
                    // Safely access recommendation with null checks
                    const recommendation = productData[product] && productData[product][segment] && productData[product][segment][trafficLevel]
                        ? productData[product][segment][trafficLevel]
                        : null;
                    let productReferences = [];

                    if (recommendation) {
                        if (Array.isArray(recommendation) && recommendation.length > 0) {
                            productReferences = recommendation[0].referencias;
                        } else if (recommendation.referencias) {
                            productReferences = recommendation.referencias;
                        }
                    }

                    referencias[product] = productReferences;

                    // Select the first RECOMMENDED reference as default (not from API response)
                    if (productReferences.length > 0) {
                        selectedReferences[product] = productReferences[0];
                    } else {
                        // If no recommendations, set to null so backend uses default
                        selectedReferences[product] = null;
                    }
                });

                // Store selected references for UI updates
                companyData.selectedReferences = selectedReferences;
                console.log('Selected references:', selectedReferences);
                const requestData = {
                    numMujeres: companyData.numMujeres,
                    numHombres: companyData.numHombres,
                    diasLaborales: companyData.diasLaborales,
                    horasLaborales: companyData.horasLaborales,
                    tipoPublico: companyData.tipoPublico,
                    sector: companyData.sector,
                    productos: companyData.products,
                    referencias: selectedReferences, // Use specific selected references instead of arrays
                    proporciones: companyData.proporciones || {}, // Incluir proporciones si existen
                    numVisitantes: companyData.numVisitantes || 0 // Incluir n√∫mero de visitantes si existe
                };

                console.log('Request data:', requestData);

                const response = await fetch('/api_consultor_integral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error('Error en el c√°lculo de consumo');
                }

                consumptionData = await response.json();
                console.log('Consumption data received:', consumptionData);
                displayRecommendationsWithConsumption(segment, trafficLevel, consumptionData);

            } catch (error) {
                console.error('Error calculando consumo:', error);
                displayRecommendationsWithConsumption(segment, trafficLevel, {});
            }
        }
        
        function displayRecommendationsWithConsumption(segment, trafficLevel, consumptionData) {
            const totalEmployees = companyData.numMujeres + companyData.numHombres;
            
            // Mapear tipos de p√∫blico para mostrar
            const tipoPublicoDisplay = {
                'administrativo': 'Administrativo',
                'operativo': 'Operativo',
                'flotante': 'Flotante'
            };
            
            // Formatear tipos de p√∫blico para mostrar
            let tiposPublicoText = '';
            if (Array.isArray(companyData.tipoPublico)) {
                tiposPublicoText = companyData.tipoPublico
                    .map(tipo => tipoPublicoDisplay[tipo] || tipo)
                    .join(', ');
            } else {
                tiposPublicoText = tipoPublicoDisplay[companyData.tipoPublico] || companyData.tipoPublico;
            }
            
            let recommendationsHTML = `
                <div class="recommendation" id="report-content">
                    <h2>Recomendaciones Personalizadas</h2>                    
                    <div class="company-summary">
                        <h3>Resumen de su Empresa</h3>
                        <p><strong>Sector:</strong> ${companyData.sector}</p>
                        <p><strong>Tama√±o:</strong> ${companyData.size}</p>
                        <p><strong>Total empleados:</strong> ${totalEmployees} (${companyData.numMujeres} mujeres, ${companyData.numHombres} hombres)</p>
                        <p><strong>Jornada laboral:</strong> ${companyData.diasLaborales} d√≠as/mes, ${companyData.horasLaborales} horas/d√≠a</p>
                        <p><strong>Tipos de p√∫blico:</strong> ${tiposPublicoText}</p>
                        <p><strong>Segmento de Ba√±os:</strong> ${segment}</p>
                        <p><strong>Nivel de tr√°fico:</strong> ${trafficLevel}</p>
                    </div>
                    
                    <div class="recommendation-title" style="display: flex; justify-content: center; align-items: center;">

                    </div>
            `;
            
            // El consumo mensual ahora est√° integrado directamente con cada recomendaci√≥n de producto
            
            // Mostrar recomendaciones de productos con consumo integrado
            companyData.products.forEach(product => {
                const recommendation = productData[product] && productData[product][segment] && productData[product][segment][trafficLevel] ? productData[product][segment][trafficLevel] : null;
                console.log(recommendation);
                const productConsumption = consumptionData[product];

                recommendationsHTML += `<h3 style="color: #00205b; font-size: 1.8em; margin: 30px 0 20px 0; border-bottom: 3px solid #00205b; padding-bottom: 10px;">${product}</h3>`;

                // Add selected reference and dispenser images
                const selectedReference = companyData.selectedReferences ? companyData.selectedReferences[product] : (productConsumption ? productConsumption.referencia_usada : '');

                // Get the first dispenser for this product
                const productRecommendation = productData[product] && productData[product][segment] && productData[product][segment][trafficLevel] ? productData[product][segment][trafficLevel] : null;
                let selectedDispenser = '';
                if (productRecommendation) {
                    if (Array.isArray(productRecommendation) && productRecommendation.length > 0) {
                        selectedDispenser = productRecommendation[0].dispensador[0];
                    } else if (productRecommendation && productRecommendation.dispensador) {
                        selectedDispenser = productRecommendation.dispensador[0];
                    }
                }

                if (selectedReference || selectedDispenser) {
                    recommendationsHTML += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    `;

                    if (selectedReference) {
                        recommendationsHTML += `
                            <div class="reference-image-container" style="text-align: center; padding: 20px; background: white; border: 2px solid #00205b;">
                                <h4 style="color: #00205b; margin-bottom: 15px; font-weight: 600;">Referencia Seleccionada: ${selectedReference}</h4>
                                <img src="{{ url_for('static', filename='images/') }}${selectedReference}.png" alt="Imagen de referencia ${selectedReference}"
                                     style="max-width: 300px; max-height: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; padding: 10px; display: block; margin: 0 auto;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; color: #64748b; font-style: italic; padding: 20px;">
                                    Imagen no disponible para la referencia ${selectedReference}
                                </div>
                            </div>
                        `;
                    }

                    if (selectedDispenser) {
                        recommendationsHTML += `
                            <div class="dispenser-image-container" style="text-align: center; padding: 20px; background: white; border: 2px solid #00205b;">
                                <h4 style="color: #00205b; margin-bottom: 15px; font-weight: 600;">Dispensador Seleccionado: ${selectedDispenser}</h4>
                                <img src="{{ url_for('static', filename='images/') }}${selectedDispenser}.jpg" alt="Imagen de dispensador ${selectedDispenser}"
                                     style="max-width: 300px; max-height: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; padding: 10px; display: block; margin: 0 auto;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; color: #64748b; font-style: italic; padding: 20px;">
                                    Imagen no disponible para el dispensador ${selectedDispenser}
                                </div>
                            </div>
                        `;
                    }

                    recommendationsHTML += `
                        </div>
                    `;
                }

                // Check if there are recommendations
                const hasReferences = recommendation && (
                    (Array.isArray(recommendation) && recommendation.length > 0 && recommendation[0].referencias && recommendation[0].referencias.length > 0) ||
                    (!Array.isArray(recommendation) && recommendation.referencias && recommendation.referencias.length > 0)
                );

                if (!hasReferences) {
                    console.log("No hay recomendaciones")
                    // No recommendations available - show message and consumption selector
                    recommendationsHTML += `
                        <div class="recommendation-group" style="margin-bottom: 25px;">
                            <div class="recommendation-grid">
                                <div>
                                    <h3 class="recommendation-option-title">No hay sugerencias disponibles</h3>
                                    <p style="color: #64748b; margin-top: 10px;">No se encontraron recomendaciones espec√≠ficas para este producto en el segmento y nivel de tr√°fico seleccionados.</p>
                                </div>
                                <div class="consumption-item">
                                    <h4 class="consumption-title">
                                        Consumo Mensual
                                    </h4>
                                    <div class="reference-selector">
                                        <label for="ref-${product.replace(/\s/g, '-')}">Referencia actual:</label>
                                        <select id="ref-${product.replace(/\s/g, '-')}" data-producto="${product}" class="reference-select">
                                            <option value="${companyData.selectedReferences ? companyData.selectedReferences[product] : (productConsumption ? productConsumption.referencia_usada : '')}">${companyData.selectedReferences ? companyData.selectedReferences[product] : (productConsumption ? productConsumption.referencia_usada : '')}</option>
                                        </select>
                                        <button class="recalculate-btn" onclick="recalcularConsumo('${product}', false, this)">Recalcular</button>
                                    </div>
                                    <p class="consumption-value" id="consumo-${product.replace(/\s/g, '-')}">
                                        ${productConsumption ? productConsumption.consumo_mensual + ' cajas/mes' : 'No aplica'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (Array.isArray(recommendation)) {

                    recommendation.forEach((rec, index) => {
                        recommendationsHTML += `
                            <div class="recommendation-group" style="margin-bottom: 25px;">
                                <div class="recommendation-grid">
                                    <div>
                                        <h3 class="recommendation-option-title">Opci√≥n ${index + 1}: ${rec.posicionamiento}</h3>
                                        <div class="recommendation-section">
                                            <h4 class="recommendation-section-title">Referencias:</h4>
                                            <div class="button-container">
                                                ${rec.referencias.map(ref => `
                                                    <button type="button" onclick="handleReferenceClick('${ref}', '${product}')" class="reference-button">${ref}</button>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div class="recommendation-section">
                                            <h4 class="recommendation-section-title">Dispensador:</h4>
                                            <div class="button-container">
                                                ${rec.dispensador.map(disp => `
                                                    <button type="button" onclick="handleDispenserClick('${disp}', '${product}')" class="dispenser-button">${disp}</button>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>

                                    ${productConsumption && index === 0 ? `
                                        <div class="consumption-item">
                                            <h4 class="consumption-title">
                                                Consumo Mensual
                                            </h4>
                                            <div class="reference-selector">
                                                <label for="ref-${product.replace(/\s/g, '-')}">Referencia actual:</label>
                                                <select id="ref-${product.replace(/\s/g, '-')}" data-producto="${product}" class="reference-select">
                                                    <option value="${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}">${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}</option>
                                                </select>
                                                <button class="recalculate-btn" onclick="recalcularConsumo('${product}', false, this)">Recalcular</button>
                                            </div>
                                            <p class="consumption-value" id="consumo-${product.replace(/\s/g, '-')}">
                                                ${productConsumption.consumo_mensual} cajas/mes
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {

                    recommendationsHTML += `
                        <div class="recommendation-group" style="margin-bottom: 25px;">
                            <div class="recommendation-grid">
                                <div>
                                    <h3 class="recommendation-option-title">${recommendation.posicionamiento}</h3>
                                    <div class="recommendation-section">
                                        <h4 class="recommendation-section-title">Referencias:</h4>
                                        <div class="button-container">
                                            ${recommendation.referencias.map(ref => `
                                                <button type="button" onclick="handleReferenceClick('${ref}', '${product}')" class="reference-button">${ref}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="recommendation-section">
                                        <h4 class="recommendation-section-title">Dispensador:</h4>
                                        <div class="button-container">
                                            ${recommendation.dispensador.map(disp => `
                                                <button type="button" onclick="handleDispenserClick('${disp}', '${product}')" class="dispenser-button">${disp}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                ${productConsumption ? `
                                    <div class="consumption-item">
                                        <h4 class="consumption-title">
                                            Consumo Mensual
                                        </h4>
                                        <div class="reference-selector">
                                            <label for="ref-${product.replace(/\s/g, '-')}">Referencia actual:</label>
                                            <select id="ref-${product.replace(/\s/g, '-')}" data-produto="${product}" class="reference-select">
                                                <option value="${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}">${companyData.selectedReferences ? companyData.selectedReferences[product] : productConsumption.referencia_usada}</option>
                                            </select>
                                            <button class="recalculate-btn" onclick="recalcularConsumo('${product}', false, this)"
                                                    style="background: #00853F; color: white; border: none;
                                                           padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
                                                           box-shadow: 0 4px 15px rgba(0, 133, 63, 0.3);">Recalcular</button>
                                        </div>
                                        <p class="consumption-value" id="consumo-${product.replace(/\s/g, '-')}"
                                           style="font-size: 1.3em; font-weight: 700; color: #00853F; margin: 10px 0 0 0;">
                                            ${productConsumption.consumo_mensual} cajas/mes
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            recommendationsHTML += `
                </div>
                <div class="navigation-buttons">
                    <button class="nav-button btn-prev" onclick="startQuiz()">Comenzar de Nuevo</button>
                    <button class="nav-button btn-next" onclick="generatePDF()">Generar Reporte</button>
                </div>
            `;
            
            document.getElementById('quiz-container').innerHTML = recommendationsHTML;

            // Cargar referencias para cada producto despu√©s de renderizar
            companyData.products.forEach(producto => {
                loadReferencesForProduct(producto);
            });
        }
        
        async function loadReferencesForProduct(producto) {
            try {
                const response = await fetch('/api_get_referencias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ producto })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const selectId = `ref-${producto.replace(/\s/g, '-')}`;
                    const select = document.getElementById(selectId);
                    
                    if (select && data.referencias) {
                        // Get recommended references for this product
                        const segment = companyData.bathroomSegment;
                        const totalEmployees = companyData.numMujeres + companyData.numHombres;
                        const trafficLevel = determineTrafficLevel(totalEmployees, companyData.diasLaborales, companyData.horasLaborales);

                        let recommendedRefs = [];
                        // Safely access recommendation with null checks
                        const recommendation = productData[producto] && productData[producto][segment] && productData[producto][segment][trafficLevel]
                            ? productData[producto][segment][trafficLevel]
                            : null;

                        if (recommendation) {
                            if (Array.isArray(recommendation)) {
                                // If multiple recommendations, collect all references
                                recommendation.forEach(rec => {
                                    recommendedRefs = recommendedRefs.concat(rec.referencias);
                                });
                            } else if (recommendation.referencias) {
                                recommendedRefs = recommendation.referencias;
                            }
                        }

                        // Remove duplicates
                        recommendedRefs = [...new Set(recommendedRefs)];
                        
                        // Limpiar opciones existentes excepto la primera (actual)
                        const currentValue = select.value;
                        select.innerHTML = '';

                        // Get the specific selected reference for this product
                        const selectedReference = companyData.selectedReferences && companyData.selectedReferences[producto]
                            ? companyData.selectedReferences[producto]
                            : (consumptionData[producto] && consumptionData[producto].referencia_usada
                                ? consumptionData[producto].referencia_usada
                                : null);

                        // Sort references: selected reference first, then other recommended, then others
                        const sortedRefs = data.referencias.sort((a, b) => {
                            const aIsSelected = selectedReference && (a === selectedReference || a.startsWith(selectedReference + ' -'));
                            const bIsSelected = selectedReference && (b === selectedReference || b.startsWith(selectedReference + ' -'));
                            const aIsRecommended = recommendedRefs.includes(a);
                            const bIsRecommended = recommendedRefs.includes(b);

                            // Selected reference goes first
                            if (aIsSelected && !bIsSelected) return -1;
                            if (!aIsSelected && bIsSelected) return 1;

                            // If both or neither are selected, sort by recommendation status
                            if (aIsRecommended && !bIsRecommended) return -1;
                            if (!aIsRecommended && bIsRecommended) return 1;
                            return 0;
                        });

                        // A√±adir todas las referencias con highlighting
                        sortedRefs.forEach(ref => {
                            const option = document.createElement('option');
                            option.value = ref;

                            // Highlight recommended references
                            if (recommendedRefs.length > 0 && recommendedRefs.includes(ref)) {
                                option.textContent = `‚≠ê ${ref} (Recomendado)`;
                            } else {
                                option.textContent = ref;
                            }

                            // Set selected to match currentValue or selectedReference
                            option.selected = ref === currentValue || ref === selectedReference || (selectedReference && ref.startsWith(selectedReference + ' -'));
                            select.appendChild(option);
                        });
                        
                        // Initialize Selectize after populating options
                        $(select).selectize({
                            searchField: ['text', 'value'],
                            maxItems: 1,
                            create: false,
                            sortField: 'text',
                            onChange: function(value) {
                                // Handle selection change if needed
                                console.log('Selectize value changed to:', value);
                                
                                // Update reference image when dropdown selection changes
                                if (value) {
                                    const producto = this.$input.data('producto');
                                    if (producto) {
                                        // Extract just the reference number from the full value (in case it has description)
                                        const referenceMatch = value.match(/^(\d+)/);
                                        const referenceNumber = referenceMatch ? referenceMatch[1] : value;
                                        updateReferenceImage(producto, referenceNumber);
                                    }
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error cargando referencias:', error);
            }
        }
        
        function displaySelected(producto) {
            console.log(producto);
            const selectId = `ref-${producto.replace(/\s/g, '-')}`;
            const select = document.getElementById(selectId);
            
            if (select && companyData.selectedReferences && companyData.selectedReferences[producto]) {
                const recommendedReference = companyData.selectedReferences[producto];
                console.log("referencia seleccionada", recommendedReference);
                
                // Find and move the recommended reference to the first position
                const options = Array.from(select.options);
                let recommendedOption = null;
                let recommendedIndex = -1;
                
                // Find the recommended option
                for (let i = 0; i < options.length; i++) {
                    const optionValue = options[i].value;
                    if (optionValue.startsWith(recommendedReference + ' -') || optionValue === recommendedReference) {
                        recommendedOption = options[i];
                        recommendedIndex = i;
                        break;
                    }
                }
                
                // If found, move it to the first position
                if (recommendedOption && recommendedIndex > 0) {
                    // Remove the option from its current position
                    select.removeChild(recommendedOption);
                    // Insert it at the beginning
                    select.insertBefore(recommendedOption, select.firstChild);
                }
                
                // Force refresh the select element
                select.style.display = 'none';
                select.offsetHeight; // Trigger reflow
                select.style.display = 'block';
            }
        }
        
        async function recalcularConsumo(producto, fromReferenceClick = false, btnEl = null) {
            const selectId = `ref-${producto.replace(/\s/g, '-')}`;
            const consumoId = `consumo-${producto.replace(/\s/g, '-')}`;
            const select = document.getElementById(selectId);
            const consumoElement = document.getElementById(consumoId);
            if (!select || !consumoElement) return;

            const nuevaReferencia = select.value;

            // Estado de carga SOLO si vino de bot√≥n (no de click en referencia)
            if (!fromReferenceClick && btnEl) {
                btnEl.disabled = true;
                btnEl.innerHTML = '‚è≥ Calculando...';
            }

            consumoElement.textContent = 'Calculando...';
            
            try {
                const requestData = {
                    numMujeres: companyData.numMujeres,
                    numHombres: companyData.numHombres,
                    diasLaborales: companyData.diasLaborales,
                    horasLaborales: companyData.horasLaborales,
                    tipoPublico: companyData.tipoPublico,
                    sector: companyData.sector,
                    producto: producto,
                    referencia: nuevaReferencia,
                    proporciones: companyData.proporciones || {}, // Incluir proporciones si existen
                    numVisitantes: companyData.numVisitantes || 0 // Incluir n√∫mero de visitantes si existe
                };
                
                const response = await fetch('/api_recalcular_consumo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.error) {
                        consumoElement.innerHTML = 'Error en el c√°lculo';
                        alert('Error: ' + data.error);
                    } else {
                        consumoElement.innerHTML = `${data.consumo_mensual} cajas/mes`;

                        // Extract reference number from select value
                        const referenceMatch = nuevaReferencia.match(/^(\d+)/);
                        const referenceNumber = referenceMatch ? referenceMatch[1] : nuevaReferencia;

                        // Check if we need to create/update the reference image
                        // Find the product heading
                        const productHeading = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.trim() === producto);

                        if (productHeading) {
                            // Check if image container already exists
                            let imageGrid = productHeading.nextElementSibling;

                            if (!imageGrid || !imageGrid.style.display || imageGrid.style.display.indexOf('grid') === -1) {
                                // Image container doesn't exist, create it
                                const newImageGrid = document.createElement('div');
                                newImageGrid.style.display = 'grid';
                                newImageGrid.style.gridTemplateColumns = '1fr 1fr';
                                newImageGrid.style.gap = '20px';
                                newImageGrid.style.margin = '20px 0';

                                const referenceContainer = document.createElement('div');
                                referenceContainer.className = 'reference-image-container';
                                referenceContainer.style.textAlign = 'center';
                                referenceContainer.style.padding = '20px';
                                referenceContainer.style.background = 'white';
                                referenceContainer.style.border = '2px solid #00205b';

                                referenceContainer.innerHTML = `
                                    <h4 style="color: #00205b; margin-bottom: 15px; font-weight: 600;">Referencia Seleccionada: ${referenceNumber}</h4>
                                    <img src="{{ url_for('static', filename='images/') }}${referenceNumber}.png" alt="Imagen de referencia ${referenceNumber}"
                                         style="max-width: 300px; max-height: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; padding: 10px; display: block; margin: 0 auto;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display: none; color: #64748b; font-style: italic; padding: 20px;">
                                        Imagen no disponible para la referencia ${referenceNumber}
                                    </div>
                                `;

                                newImageGrid.appendChild(referenceContainer);
                                productHeading.parentNode.insertBefore(newImageGrid, productHeading.nextSibling);
                            } else {
                                // Update existing image
                                updateReferenceImage(producto, referenceNumber);
                            }
                        }
                    }
                } else {
                    consumoElement.innerHTML = 'Error en el c√°lculo';
                    alert('Error al recalcular el consumo');
                }
            } catch (error) {
                console.error('Error recalculando consumo:', error);
                consumoElement.textContent = 'Error en el c√°lculo';
                alert('Error de conexi√≥n al recalcular');
            } finally {
                if (!fromReferenceClick && btnEl) {
                    btnEl.disabled = false;
                    btnEl.textContent = 'Recalcular';
                }
            }
        }
        
        // Nueva funci√≥n para generar el PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const element = document.getElementById('report-content');
            
            // Call saveReporte before generating PDF
            saveReporte();
            
            // Ocultar botones de navegaci√≥n antes de la captura
            const navButtons = document.querySelector('.navigation-buttons');
            navButtons.style.display = 'none';

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; 
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const filename = `Reporte_${companyData.sector.replace(/\s/g, '_')}.pdf`;
                doc.save(filename);
                
                // Mostrar botones de navegaci√≥n de nuevo
                navButtons.style.display = 'flex';
            });
        }
        
        // Nueva funci√≥n para guardar el reporte
        async function saveReporte() {
            try {
                // Prepare portfolio data
                const portfolioData = {
                    sector: companyData.sector,
                    mujeres: companyData.numMujeres,
                    hombres: companyData.numHombres,
                    dias: companyData.diasLaborales,
                    horas: companyData.horasLaborales,
                    tipo: companyData.tipoPublico,
                    refpapel: null,
                    conspapel: null,
                    refjabones: null,
                    consjabones: null,
                    reftoallas: null,
                    constoallas: null
                };

                // Extract product data if available
                if (typeof consumptionData !== 'undefined' && Object.keys(consumptionData).length > 0) {
                    Object.keys(consumptionData).forEach(producto => {
                        const productData = consumptionData[producto];
                        const selectElement = document.getElementById(`ref-${producto.replace(/\s/g, '-')}`);
                        const referencia = selectElement ? selectElement.value : null;
                        
                        // Map products to database fields
                        if (producto.toLowerCase().includes('papel')) {
                            portfolioData.refpapel = referencia;
                            portfolioData.conspapel = productData.consumo_mensual;
                        } else if (producto.toLowerCase().includes('jab√≥n') || producto.toLowerCase().includes('jabon')) {
                            portfolioData.refjabones = referencia;
                            portfolioData.consjabones = productData.consumo_mensual;
                        } else if (producto.toLowerCase().includes('toalla')) {
                            portfolioData.reftoallas = referencia;
                            portfolioData.constoallas = productData.consumo_mensual;
                        }
                    });
                }

                console.log('Enviando portfolio:', portfolioData);

                // Send data to backend
                const response = await fetch('/save_portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(portfolioData)
                });

                if (response.ok) {
                    const result = await response.text();
                    console.log('Portfolio guardado exitosamente:', result);
                } else {
                    console.error('Error guardando portfolio:', response.status);
                }

            } catch (error) {
                console.error('Error enviando portfolio:', error);
            }
        }
        
        // Function to update reference image when reference is selected
        function updateReferenceImage(productName, referenceText) {
            // Find all reference image containers for this product
            const productHeading = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes(`${productName}`));
            if (productHeading) {
                // Find the reference image container within the grid
                const gridContainer = productHeading.nextElementSibling;
                if (gridContainer) {
                    const referenceContainer = gridContainer.querySelector('.reference-image-container');
                    if (referenceContainer) {
                        // Update the heading
                        const heading = referenceContainer.querySelector('h4');
                        if (heading) {
                            heading.textContent = `Referencia Seleccionada: ${referenceText}`;
                        }

                        // Update the image
                        const img = referenceContainer.querySelector('img');
                        const fallback = referenceContainer.querySelector('div[style*="display: none"]');
                        if (img && fallback) {
                            img.src = `{{ url_for('static', filename='images/') }}${referenceText}.png`;
                            img.alt = `Imagen de referencia ${referenceText}`;
                            img.style.display = 'block';
                            img.style.margin = '0 auto';
                            fallback.style.display = 'none';
                            fallback.innerHTML = `Imagen no disponible para la referencia ${referenceText}`;
                        }
                    }
                }
            }
        }

        // Function to update dispenser image when dispenser is selected
        function updateDispenserImage(productName, dispenserText) {
            // Find all dispenser image containers for this product
            const productHeading = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes(`${productName}`));
            if (productHeading) {
                // Find the dispenser image container within the grid
                const gridContainer = productHeading.nextElementSibling;
                if (gridContainer) {
                    const dispenserContainer = gridContainer.querySelector('.dispenser-image-container');
                    if (dispenserContainer) {
                        // Update the heading
                        const heading = dispenserContainer.querySelector('h4');
                        if (heading) {
                            heading.textContent = `Dispensador Seleccionado: ${dispenserText}`;
                        }

                        // Update the image (using placeholder for now)
                        const img = dispenserContainer.querySelector('img');
                        const fallback = dispenserContainer.querySelector('div[style*="display: none"]');
                        if (img && fallback) {
                            img.src = `{{ url_for('static', filename='images/') }}${dispenserText}.jpg`;
                            img.alt = `Imagen de dispensador ${dispenserText}`;
                            img.style.display = 'block';
                            img.style.margin = '0 auto';
                            fallback.style.display = 'none';
                            fallback.innerHTML = `Imagen no disponible para el dispensador ${dispenserText}`;
                        }
                    }
                }
            }
        }

        // Method to handle reference button clicks
        function handleReferenceClick(referenceText, productName) {
            console.log('Reference clicked:', referenceText, 'for product:', productName);
            
            // Find the corresponding select element
            const selectId = `ref-${productName.replace(/\s/g, '-')}`;
            const selectElement = document.getElementById(selectId);
            
            if (selectElement) {
                // Get the Selectize instance
                const selectizeInstance = selectElement.selectize;
                
                if (selectizeInstance) {
                    // Use Selectize API to find and set value
                    let foundValue = null;
                    
                    // First try exact match
                    if (selectizeInstance.options[referenceText]) {
                        foundValue = referenceText;
                    } else {
                        // Look for partial match in all options
                        for (let optionValue in selectizeInstance.options) {
                            if (optionValue.startsWith(referenceText + ' -') || 
                                optionValue.includes(referenceText)) {
                                foundValue = optionValue;
                                break;
                            }
                        }
                    }
                    
                    if (foundValue) {
                        // Set the value using Selectize API
                        selectizeInstance.setValue(foundValue, false); // false = don't trigger change event
                        
                        console.log('Selected reference updated to:', foundValue);
                        
                        // Update the reference image
                        updateReferenceImage(productName, referenceText);
                        
                        // Manually trigger recalculation since we suppressed the change event
                        recalcularConsumo(productName, true);
                    } else {
                        console.log('No matching option found for reference:', referenceText);
                        console.log('Available options:', Object.keys(selectizeInstance.options));
                    }
                } else {
                    // Fallback to native select if Selectize not initialized
                    console.log('Selectize not found, using native select');
                    
                    let foundOption = false;
                    
                    // First try exact match
                    for (let option of selectElement.options) {
                        if (option.value === referenceText) {
                            selectElement.value = referenceText;
                            foundOption = true;
                            break;
                        }
                    }
                    
                    // If exact match not found, look for partial match
                    if (!foundOption) {
                        for (let option of selectElement.options) {
                            if (option.value.startsWith(referenceText + ' -') || 
                                option.value.includes(referenceText)) {
                                selectElement.value = option.value;
                                foundOption = true;
                                break;
                            }
                        }
                    }
                    
                    if (foundOption) {
                        console.log('Selected reference updated to:', selectElement.value);
                        // Update the reference image
                        updateReferenceImage(productName, referenceText);
                        recalcularConsumo(productName, true);
                    }
                }
            } else {
                console.log('Select element not found:', selectId);
            }
        }
        
        function handleDispenserClick(dispenserText, productName) {
            console.log('Dispenser clicked:', dispenserText, 'for product:', productName);

            // Update the dispenser image
            updateDispenserImage(productName, dispenserText);
        }
        
        function startQuiz() {
            currentStep = 0;
            companyData = {};
            selectedProducts = [];
            selectedPublicTypes = [];
            selectedBathroomSegment = '';
            initializeStepsList();
            renderStep();
        }
        
        // Inicializar el cuestionario
        document.addEventListener('DOMContentLoaded', async function() {
            // Load product data from Portfolio.xlsx before starting the quiz
            await loadProductData();
            startQuiz();
        });
    </script>
</body>
</html>
